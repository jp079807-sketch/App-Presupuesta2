<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuesta2 - Finanzas Inteligentes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #4F46E5;
            --primary-light: #6366F1;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --bg: #F9FAFB;
            --card: #FFFFFF;
            --text: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
        }
        
        [data-theme="dark"] {
            --primary: #6366F1;
            --primary-light: #818CF8;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --bg: #111827;
            --card: #1F2937;
            --text: #F9FAFB;
            --text-light: #9CA3AF;
            --border: #374151;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            transition: all 0.3s; 
        }
        
        /* === AUTH STYLES === */
        .auth-container { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
        }
        
        .auth-card { 
            background: var(--card); 
            padding: 2.5rem; 
            border-radius: 20px; 
            max-width: 420px; 
            width: 100%; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        
        .auth-logo { 
            text-align: center; 
            margin-bottom: 2rem; 
        }
        
        .auth-logo h1 { 
            font-size: 2.5rem; 
            margin-bottom: 0.5rem;
        }
        
        .auth-logo p { 
            color: var(--text-light); 
            font-size: 0.95rem;
        }
        
        .auth-tabs { 
            display: flex; 
            gap: 0.5rem; 
            margin-bottom: 2rem;
            background: var(--bg);
            padding: 0.25rem;
            border-radius: 12px;
        }
        
        .auth-tab { 
            flex: 1; 
            padding: 0.75rem; 
            border: none; 
            background: transparent;
            border-radius: 10px; 
            font-weight: 600; 
            cursor: pointer;
            color: var(--text);
            transition: all 0.2s;
        }
        
        .auth-tab.active { 
            background: var(--card); 
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .forgot-password {
            text-align: center;
            margin-top: 1rem;
        }
        
        .forgot-password a {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .forgot-password a:hover {
            text-decoration: underline;
        }
        
        .auth-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
            display: none;
        }
        
        .auth-message.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            display: block;
        }
        
        .auth-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
            display: block;
        }
        
        /* === MAIN APP STYLES === */
        .app { 
            display: none; 
        }
        
        .app.active { 
            display: block; 
        }
        
        .header { 
            background: linear-gradient(135deg, var(--primary), var(--primary-light)); 
            color: white; 
            padding: 1.5rem; 
            position: sticky; 
            top: 0; 
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .logo { 
            font-size: 1.5rem; 
            font-weight: 700; 
        }
        
        .user-menu { 
            display: flex; 
            gap: 1rem; 
            align-items: center; 
        }
        
        .space-selector { 
            background: rgba(255,255,255,0.2); 
            padding: 0.5rem 1rem; 
            border-radius: 8px; 
            border: none; 
            color: white; 
            cursor: pointer;
            font-weight: 500;
        }
        
        .space-selector option {
            color: var(--text);
        }
        
        .settings-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .nav-menu { 
            display: flex; 
            gap: 1rem; 
            padding: 1rem; 
            background: var(--card); 
            overflow-x: auto; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--border);
        }
        
        .nav-menu::-webkit-scrollbar {
            height: 6px;
        }
        
        .nav-menu::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .nav-item { 
            padding: 0.5rem 1rem; 
            border-radius: 8px; 
            cursor: pointer; 
            white-space: nowrap; 
            font-weight: 500; 
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .nav-item:hover { 
            background: var(--bg);
            border-color: var(--border);
        }
        
        .nav-item.active { 
            background: var(--primary); 
            color: white;
            border-color: var(--primary);
        }
        
        .dashboard { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 2rem; 
        }
        
        .welcome { 
            margin-bottom: 2rem; 
        }
        
        .welcome h1 { 
            font-size: 2rem; 
            margin-bottom: 0.5rem; 
        }
        
        .welcome p { 
            color: var(--text-light); 
            font-size: 1rem; 
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin-top: 1.5rem; 
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }
        
        .card { 
            background: var(--card); 
            border-radius: 16px; 
            padding: 1.5rem; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1rem; 
        }
        
        .card-title { 
            font-size: 1.1rem; 
            font-weight: 600; 
        }
        
        /* === DASHBOARD ESPEC√çFICO === */
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .stat-card.income {
            border-left-color: var(--secondary);
        }
        
        .stat-card.expense {
            border-left-color: var(--danger);
        }
        
        .stat-card.pending {
            border-left-color: var(--warning);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .stat-card.income .stat-value {
            color: var(--secondary);
        }
        
        .stat-card.expense .stat-value {
            color: var(--danger);
        }
        
        .stat-card.pending .stat-value {
            color: var(--warning);
        }
        
        .comparison-card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .comparison-item:last-child {
            border-bottom: none;
        }
        
        .comparison-label {
            font-weight: 500;
        }
        
        .comparison-value {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .trend-indicator {
            display: inline-block;
            margin-left: 0.5rem;
            font-size: 0.9rem;
        }
        
        .trend-up {
            color: var(--danger);
        }
        
        .trend-down {
            color: var(--secondary);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--secondary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-fill.danger {
            background: var(--danger);
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        
        .payment-item:hover {
            background: var(--bg);
        }
        
        .payment-info {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .payment-date {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .payment-amount {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .payment-status {
            margin-left: 1rem;
        }
        
        .balance-card { 
            background: linear-gradient(135deg, var(--secondary), #059669);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .balance-label { 
            font-size: 0.95rem; 
            opacity: 0.9; 
            margin-bottom: 0.5rem; 
        }
        
        .balance-amount { 
            font-size: 3rem; 
            font-weight: 700; 
        }
        
        .btn { 
            padding: 0.75rem 1.5rem; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s;
            font-size: 1rem;
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        
        .btn-primary:hover { 
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-small { 
            padding: 0.5rem 1rem; 
            font-size: 0.9rem; 
        }
        
        .empty-state { 
            text-align: center; 
            padding: 3rem 1rem; 
            color: var(--text-light); 
        }
        
        .empty-state-icon { 
            font-size: 3rem; 
            margin-bottom: 1rem; 
        }
        
        .form-group { 
            margin-bottom: 1.25rem; 
        }
        
        .form-label { 
            display: block; 
            margin-bottom: 0.5rem; 
            font-weight: 600; 
            color: var(--text);
        }
        
        .form-input, .form-select { 
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid var(--border); 
            border-radius: 8px; 
            font-size: 1rem;
            background: var(--bg);
            color: var(--text);
            transition: all 0.2s;
        }
        
        .form-input:focus, .form-select:focus { 
            outline: none; 
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .page { 
            display: none; 
        }
        
        .page.active { 
            display: block; 
        }
        
        /* === MODAL STYLES === */
        .modal { 
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .modal.active { 
            display: flex; 
        }
        
        .modal-content { 
            background: var(--card);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-title { 
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .modal-content form { 
            padding: 1.5rem; 
        }
        
        .close-btn { 
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .close-btn:hover { 
            background: var(--bg);
            color: var(--text);
        }
        
        /* === FAB === */
        .fab { 
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.4);
            transition: all 0.3s;
            z-index: 90;
        }
        
        .fab:hover { 
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5);
        }
        
        /* === SIDEBAR === */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 998;
            display: none;
            backdrop-filter: blur(2px);
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        .sidebar { 
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: var(--card);
            box-shadow: -4px 0 20px rgba(0,0,0,0.2);
            z-index: 999;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .sidebar.active { 
            right: 0; 
        }
        
        .sidebar-header { 
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-title { 
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .sidebar-content { 
            padding: 1.5rem; 
        }
        
        .sidebar-section { 
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .sidebar-section-header { 
            padding: 1rem 1.5rem;
            background: var(--bg);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .sidebar-section-header:hover {
            background: var(--border);
        }
        
        .sidebar-section-title { 
            font-weight: 600;
            font-size: 1rem;
        }
        
        .sidebar-section-arrow { 
            transition: transform 0.3s;
            font-size: 0.8rem;
        }
        
        .sidebar-section-arrow.open {
            transform: rotate(180deg);
        }
        
        .sidebar-section-content { 
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 1.5rem;
        }
        
        .sidebar-section-content.open { 
            max-height: 1000px;
            padding: 1.5rem;
        }
        
        .toggle-switch { 
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }
        
        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider { 
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border);
            transition: 0.4s;
            border-radius: 28px;
        }
        
        .toggle-slider:before { 
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider { 
            background: var(--primary); 
        }
        
        input:checked + .toggle-slider:before { 
            transform: translateX(24px); 
        }
        
        .badge { 
            padding: 0.5rem 1rem; 
            border-radius: 12px; 
            font-size: 0.9rem; 
            font-weight: 600; 
            display: inline-block; 
            margin: 0.25rem; 
        }
        
        .badge-primary { 
            background: rgba(79, 70, 229, 0.1); 
            color: var(--primary); 
        }
        
        .badge-success { 
            background: rgba(16, 185, 129, 0.1); 
            color: var(--secondary); 
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        /* Calculation Box */
        .calculation-box {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }
        
        .calculation-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.95rem;
        }
        
        .calculation-row.total {
            border-top: 2px solid var(--border);
            margin-top: 0.5rem;
            padding-top: 0.75rem;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .sidebar { 
                width: 100%; 
                right: -100%; 
            }
            
            .dashboard { 
                padding: 1rem; 
            }
            
            .balance-amount { 
                font-size: 2rem; 
            }
            
            .grid, .grid-2, .grid-4 { 
                grid-template-columns: 1fr; 
            }
            
            .stat-cards {
                grid-template-columns: 1fr;
            }
            
            .fab { 
                bottom: 1rem; 
                right: 1rem; 
                width: 56px; 
                height: 56px; 
            }
            
            .auth-card {
                padding: 2rem;
            }
        }
        /* === MONTH SELECTOR === */
        .month-selector {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: 500;
            min-width: 200px;
        }
        
        .month-selector option {
            color: var(--text);
        }
        
        /* === DATA TABLE === */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .data-table thead {
            background: var(--bg);
        }
        
        .data-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }
        
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .data-table tbody tr:hover {
            background: var(--bg);
        }
        
        .data-table tfoot {
            background: var(--bg);
            font-weight: 700;
        }
        
        .data-table tfoot td {
            padding: 1rem;
            border-top: 2px solid var(--border);
        }
        
        /* === BUTTONS === */
        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* === CHART CONTAINER === */
        .chart-container {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
            min-height: 300px;
        }
        
        /* === CONFIRM DIALOG === */
        .confirm-dialog {
            background: var(--card);
            padding: 2rem;
            border-radius: 16px;
            max-width: 400px;
            text-align: center;
        }
        
        .confirm-dialog h3 {
            margin-bottom: 1rem;
            color: var(--danger);
        }
        
        .confirm-dialog p {
            margin-bottom: 1.5rem;
            color: var(--text-light);
        }
        
        .confirm-dialog-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- AUTH SCREEN -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <h1>üí∞ Presupuesta2</h1>
                <p>Control financiero inteligente</p>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Iniciar Sesi√≥n</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Registrarse</button>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="tu@email.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Iniciar Sesi√≥n</button>
                
                <div class="forgot-password">
                    <a href="#" onclick="showPasswordRecovery(); return false;">¬øOlvidaste tu contrase√±a?</a>
                </div>
            </form>
            
            <!-- Register Form -->
            <form id="registerForm" style="display:none" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-input" id="registerName" placeholder="Tu nombre" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="registerEmail" placeholder="tu@email.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" class="form-input" id="registerPassword" placeholder="M√≠nimo 6 caracteres" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Crear Cuenta</button>
            </form>
            
            <!-- Password Recovery Form -->
            <form id="recoveryForm" style="display:none" onsubmit="handlePasswordRecovery(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="recoveryEmail" placeholder="tu@email.com" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Enviar Enlace de Recuperaci√≥n</button>
                <button type="button" class="btn btn-secondary" style="width:100%; margin-top: 0.5rem;" onclick="showAuthTab('login')">Volver</button>
            </form>
            
            <div id="authMessage" class="auth-message"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="app">
        <header class="header">
            <div class="header-content">
                <div class="logo">üí∞ Presupuesta2</div>
                <div class="user-menu">
                    <select class="month-selector" id="monthSelector" onchange="changeMonth()">
                        <!-- Se llena autom√°ticamente con JavaScript -->
                    </select>
                    <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
                </div>
            </div>
        </header>

          <nav class="nav-menu">
            <div class="nav-item active" onclick="showPage('dashboard', this)">üìä Dashboard</div>
            <div class="nav-item" onclick="showPage('ingresos', this)">üíµ Ingresos</div>
            <div class="nav-item" onclick="showPage('pagos', this)">üìÖ Pagos del Mes</div>
            <div class="nav-item" onclick="showPage('deudas', this)">üí≥ Deudas</div>
            <div class="nav-item" onclick="showPage('mercado', this)">üõí Mercado</div>
            <div class="nav-item" onclick="showPage('historico', this)">üìà Hist√≥rico</div>
        </nav>

        <main class="dashboard">
           <!-- ========== DASHBOARD PAGE ========== -->
            <div id="dashboard" class="page active">
                <div class="welcome">
                    <h1>Hola, <span id="userName">Usuario</span> üëã</h1>
                    <p id="cycleDisplay">Cargando per√≠odo...</p>
                </div>
                
                <!-- Balance Principal -->
                <div class="balance-card">
                    <div class="balance-label">Balance Disponible</div>
                    <div class="balance-amount" id="balanceAmount">$0</div>
                </div>
                
                <!-- Resumen Principal -->
                <div class="stat-cards">
                    <div class="stat-card">
                        <div class="stat-label">Presupuesto Mensual</div>
                        <div class="stat-value" id="dashBudget">$0</div>
                    </div>
                    
                    <div class="stat-card income">
                        <div class="stat-label">Ingresos del Mes</div>
                        <div class="stat-value" id="dashIncomes">$0</div>
                    </div>
                    
                    <div class="stat-card expense">
                        <div class="stat-label">Gastos Totales</div>
                        <div class="stat-value" id="dashExpenses">$0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Gastos Pagados</div>
                        <div class="stat-value" id="dashPaid">$0</div>
                    </div>
                    
                    <div class="stat-card pending">
                        <div class="stat-label">Gastos Pendientes</div>
                        <div class="stat-value" id="dashPending">$0</div>
                    </div>
                </div>
                
                <!-- Grid de 2 columnas -->
                <div class="grid-2">
                    <!-- Gr√°fica de Tendencia -->
                    <div class="chart-container">
                        <h3 class="card-title" style="margin-bottom: 1rem;">üìà Tendencia (√öltimos 6 meses)</h3>
                        <canvas id="trendChart"></canvas>
                    </div>
                    
                    <!-- Comparaci√≥n vs Mes Anterior -->
                    <div class="comparison-card">
                        <h3 class="card-title" style="margin-bottom: 1rem;">üìä Comparaci√≥n vs Mes Anterior</h3>
                        <div class="comparison-item">
                            <span class="comparison-label">Ingresos</span>
                            <span class="comparison-value" id="compIncomes">$0 <span class="trend-indicator">-</span></span>
                        </div>
                        <div class="comparison-item">
                            <span class="comparison-label">Gastos</span>
                            <span class="comparison-value" id="compExpenses">$0 <span class="trend-indicator">-</span></span>
                        </div>
                        <div class="comparison-item">
                            <span class="comparison-label">Balance</span>
                            <span class="comparison-value" id="compBalance">$0 <span class="trend-indicator">-</span></span>
                        </div>
                    </div>
                </div>
                
                <!-- Grid de 2 columnas -->
                <div class="grid-2">
                    <!-- Presupuesto de Mercado -->
                    <div class="comparison-card">
                        <h3 class="card-title" style="margin-bottom: 1rem;">üõí Presupuesto de Mercado</h3>
                        <div class="comparison-item">
                            <span class="comparison-label">Presupuesto Total</span>
                            <span class="comparison-value" id="marketBudget">$0</span>
                        </div>
                        <div class="comparison-item">
                            <span class="comparison-label">Gastado</span>
                            <span class="comparison-value" style="color: var(--danger);" id="marketSpent">$0</span>
                        </div>
                        <div class="comparison-item">
                            <span class="comparison-label">Disponible</span>
                            <span class="comparison-value" style="color: var(--secondary);" id="marketAvailable">$0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="marketProgress" style="width: 0%"></div>
                        </div>
                        <p style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                            <span id="marketPercent">0%</span> consumido
                        </p>
                    </div>
                    
                    <!-- Pr√≥ximos Pagos -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìÖ Pr√≥ximos Pagos (5 d√≠as)</h3>
                            <button class="btn btn-small btn-primary" onclick="showPage('pagos', document.querySelectorAll('.nav-item')[2])">Ver Todos</button>
                        </div>
                        <div id="upcomingPayments">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚úÖ</div>
                                <p>No hay pagos pr√≥ximos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =============== INGRESOS PAGE =============== -->
            <div id="ingresos" class="page">
                <div class="welcome">
                    <h1>üíµ Ingresos</h1>
                    <p>Gestiona tus fuentes de ingreso</p>
                </div>
                
                <button class="btn btn-primary" onclick="openModal('addIngresoModal')" style="margin-bottom: 1.5rem;">
                    ‚ûï Agregar Ingreso
                </button>
                
                <div class="empty-state">
                    <div class="empty-state-icon">üíµ</div>
                    <p>No has registrado ingresos a√∫n</p>
                    <button class="btn btn-primary btn-small" style="margin-top:1rem" onclick="openModal('addIngresoModal')">Agregar Primer Ingreso</button>
                </div>
            </div>

            <!-- =============== GASTOS FIJOS PAGE =============== -->
            <div id="gastos-fijos" class="page">
                <div class="welcome">
                    <h1>üìå Gastos Fijos</h1>
                    <p>Gastos recurrentes mensuales</p>
                </div>
                
                <button class="btn btn-primary" onclick="openModal('addGastoFijoModal')" style="margin-bottom: 1.5rem;">
                    ‚ûï Agregar Gasto Fijo
                </button>
                
                <div class="empty-state">
                    <div class="empty-state-icon">üìå</div>
                    <p>No tienes gastos fijos registrados</p>
                    <button class="btn btn-primary btn-small" style="margin-top:1rem" onclick="openModal('addGastoFijoModal')">Agregar Primer Gasto Fijo</button>
                </div>
            </div>

            <!-- =============== GASTOS VARIABLES PAGE =============== -->
            <div id="gastos-variables" class="page">
                <div class="welcome">
                    <h1>üí∏ Gastos Variables</h1>
                    <p>Gastos ocasionales y compras</p>
                </div>
                
                <button class="btn btn-primary" onclick="openModal('quickAddModal')" style="margin-bottom: 1.5rem;">
                    ‚ûï Agregar Gasto Variable
                </button>
                
                <div class="empty-state">
                    <div class="empty-state-icon">üí∏</div>
                    <p>No has registrado gastos variables</p>
                    <button class="btn btn-primary btn-small" style="margin-top:1rem" onclick="openModal('quickAddModal')">Agregar Primer Gasto</button>
                </div>
            </div>

            <!-- =============== CATEGOR√çAS PAGE =============== -->
            <div id="categorias" class="page">
                <div class="welcome">
                    <h1>üè∑Ô∏è Categor√≠as</h1>
                    <p>Organiza tus gastos por categor√≠as</p>
                </div>
                
                <button class="btn btn-primary" onclick="openModal('addCategoriaModal')" style="margin-bottom: 1.5rem;">
                    ‚ûï Crear Categor√≠a Personalizada
                </button>
                
                <div class="grid">
                    <div class="card">
                        <h3 class="card-title">Categor√≠as Predefinidas</h3>
                        <div style="margin-top: 1rem;">
                            <span class="badge badge-primary">üè† Vivienda</span>
                            <span class="badge badge-primary">üí° Servicios</span>
                            <span class="badge badge-primary">üçî Comida</span>
                            <span class="badge badge-primary">üöó Transporte</span>
                            <span class="badge badge-primary">üéÆ Entretenimiento</span>
                            <span class="badge badge-primary">üëï Ropa</span>
                            <span class="badge badge-primary">üíä Salud</span>
                            <span class="badge badge-primary">üéì Educaci√≥n</span>
                            <span class="badge badge-primary">üì¶ Otros</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Categor√≠as Personalizadas</h3>
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ú®</div>
                            <p style="font-size: 0.9rem;">Crea categor√≠as personalizadas para tus necesidades</p>
                        </div>
                    </div>
                </div>
            </div>
        <!-- ========== PAGOS DEL MES PAGE ========== -->
            <div id="pagos" class="page">
                <div class="welcome">
                    <h1>üìÖ Pagos del Mes</h1>
                    <p>Control operativo de todos tus pagos</p>
                </div>
                
                <!-- Resumen de Pagos -->
                <div class="stat-cards" style="margin-bottom: 1.5rem;">
                    <div class="stat-card expense">
                        <div class="stat-label">Total del Mes</div>
                        <div class="stat-value" id="pagosTot">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pagado</div>
                        <div class="stat-value" style="color: var(--secondary);" id="pagosPagado">$0</div>
                    </div>
                    <div class="stat-card pending">
                        <div class="stat-label">Pendiente</div>
                        <div class="stat-value" id="pagosPendiente">$0</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-label">Vencido</div>
                        <div class="stat-value" id="pagosVencido">$0</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">Todos los Pagos</h3>
                    <div id="pagosContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <p>No hay pagos registrados para este mes</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== DEUDAS PAGE ========== -->
            <div id="deudas" class="page">
                <div class="welcome">
                    <h1>üí≥ Deudas</h1>
                    <p>Seguimiento de deudas a largo plazo</p>
                </div>
                
                <button class="btn btn-primary" onclick="openModal('addDeudaModal')" style="margin-bottom: 1.5rem;">
                    ‚ûï Registrar Deuda
                </button>
                
                <div id="deudasContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí≥</div>
                        <p>No tienes deudas registradas</p>
                        <button class="btn btn-primary btn-small" style="margin-top:1rem" onclick="openModal('addDeudaModal')">Registrar Primera Deuda</button>
                    </div>
                </div>
            </div>

            <!-- ========== MERCADO PAGE ========== -->
            <div id="mercado" class="page">
                <div class="welcome">
                    <h1>üõí Mercado</h1>
                    <p>Control de presupuesto de mercado</p>
                </div>
                
                <div class="grid-2" style="margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="openModal('setBudgetModal')">
                        üí∞ Establecer Presupuesto
                    </button>
                    <button class="btn btn-secondary" onclick="openModal('addCompraModal')">
                        ‚ûï Registrar Compra
                    </button>
                </div>
                
                <!-- Resumen de Mercado -->
                <div class="comparison-card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem;">üìä Resumen del Mes</h3>
                    <div class="comparison-item">
                        <span class="comparison-label">Presupuesto</span>
                        <span class="comparison-value" id="mercadoPresupuesto">$0</span>
                    </div>
                    <div class="comparison-item">
                        <span class="comparison-label">Gastado</span>
                        <span class="comparison-value" style="color: var(--danger);" id="mercadoGastado">$0</span>
                    </div>
                    <div class="comparison-item">
                        <span class="comparison-label">Disponible</span>
                        <span class="comparison-value" style="color: var(--secondary);" id="mercadoDisponible">$0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="mercadoProgress" style="width: 0%"></div>
                    </div>
                    <p style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                        <span id="mercadoPercent">0%</span> consumido
                    </p>
                </div>
                
                <div class="card">
                    <h3 class="card-title">Compras del Mes</h3>
                    <div id="comprasContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">üõí</div>
                            <p>No has registrado compras este mes</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== HIST√ìRICO PAGE ========== -->
            <div id="historico" class="page">
                <div class="welcome">
                    <h1>üìà Hist√≥rico</h1>
                    <p>An√°lisis y reportes mensuales</p>
                </div>
                
                <!-- Filtros -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Desde</label>
                            <input type="month" class="form-input" id="historicoDesde">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hasta</label>
                            <input type="month" class="form-input" id="historicoHasta">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="loadHistorico()">üîç Generar Reporte</button>
                </div>
                
                <div id="historicoContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>Selecciona un rango de fechas para ver el hist√≥rico</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- FAB Button -->
        <button class="fab" onclick="openModal('quickAddModal')">+</button>
    </div>

    <!-- =============== SIDEBAR (SETTINGS) =============== -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSettings()"></div>
    <div class="sidebar" id="settingsSidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">‚öôÔ∏è Configuraci√≥n</h2>
            <button class="close-btn" onclick="closeSettings()" style="color: white;">√ó</button>
        </div>
        <div class="sidebar-content">
            <!-- User Info -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('user')">
                    <span class="sidebar-section-title">üë§ Usuario</span>
                    <span class="sidebar-section-arrow" id="user-arrow">‚ñº</span>
                </div>
                <div class="sidebar-section-content" id="user-content">
                    <p style="margin-bottom: 0.5rem;"><strong>Email:</strong> <span id="userEmail">-</span></p>
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-input" id="userNameInput" placeholder="Tu nombre">
                        <button class="btn btn-primary btn-small" style="margin-top: 0.5rem;" onclick="updateUserName()">üíæ Guardar Nombre</button>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="handleLogout()">üö™ Cerrar Sesi√≥n</button>
                </div>
            </div>

            <!-- Preferences -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('preferences')">
                    <span class="sidebar-section-title">üé® Preferencias</span>
                    <span class="sidebar-section-arrow" id="preferences-arrow">‚ñº</span>
                </div>
                <div class="sidebar-section-content" id="preferences-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span>üåô Modo Oscuro</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">üí∞ Moneda</label>
                        <select class="form-select" id="monedaSelect">
                            <option value="COP">COP - Peso Colombiano</option>
                            <option value="USD">USD - D√≥lar</option>
                            <option value="EUR">EUR - Euro</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">üìÖ D√≠a de Inicio del Ciclo</label>
                        <input type="number" class="form-input" id="cicloInput" value="20" min="1" max="31">
                        <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">El d√≠a del mes en que comienza tu ciclo de presupuesto</p>
                    </div>
                    
                    <button class="btn btn-primary" style="width: 100%;" onclick="savePreferences()">üíæ Guardar Preferencias</button>
                </div>
            </div>

            <!-- About -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('about')">
                    <span class="sidebar-section-title">‚ÑπÔ∏è Acerca de</span>
                    <span class="sidebar-section-arrow" id="about-arrow">‚ñº</span>
                </div>
                <div class="sidebar-section-content" id="about-content">
                    <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>Presupuesta2</strong></p>
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem;">Versi√≥n 2.1.0</p>
                    <p style="font-size: 0.85rem; color: var(--text-light);">Sistema de control financiero personal con dashboard inteligente.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- =============== MODALS =============== -->
    
    <!-- Quick Add Expense Modal -->
    <div class="modal" id="quickAddModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∏ Agregar Gasto R√°pido</h2>
                <button class="close-btn" onclick="closeModal('quickAddModal')">√ó</button>
            </div>
            <form onsubmit="addQuickExpense(event)">
                <div class="form-group">
                    <label class="form-label">Monto (COP)</label>
                    <input type="number" class="form-input" placeholder="50000" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Categor√≠a</label>
                    <select class="form-select" required>
                        <option>üè† Vivienda</option>
                        <option>üí° Servicios</option>
                        <option>üçî Comida</option>
                        <option>üöó Transporte</option>
                        <option>üéÆ Entretenimiento</option>
                        <option>üëï Ropa</option>
                        <option>üíä Salud</option>
                        <option>üéì Educaci√≥n</option>
                        <option>üì¶ Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n (opcional)</label>
                    <input type="text" class="form-input" placeholder="Ej: Almuerzo, Uber, Netflix">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Agregar Gasto</button>
            </form>
        </div>
    </div>

    <!-- Add Income Modal -->
    <div class="modal" id="addIngresoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üíµ Agregar Ingreso</h2>
                <button class="close-btn" onclick="closeModal('addIngresoModal')">√ó</button>
            </div>
            <form onsubmit="addIngreso(event)">
                <div class="form-group">
                    <label class="form-label">Fuente de Ingreso</label>
                    <input type="text" class="form-input" id="ingresoFuente" placeholder="Ej: Salario Google, Freelance dise√±o" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo de Contrato</label>
                    <select class="form-select" id="ingresoTipo" onchange="updateIngresoCalculation()" required>
                        <option value="laboral">üíº Contrato Laboral (Descuento 8%)</option>
                        <option value="servicios">üí∞ Prestaci√≥n de Servicios (Descuento 28.5%)</option>
                        <option value="exento">üéÅ Bonos/Otros (Sin descuento)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Monto Bruto (COP)</label>
                    <input type="number" class="form-input" id="ingresoBruto" placeholder="0" oninput="updateIngresoCalculation()" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Frecuencia</label>
                    <select class="form-select" id="ingresoFrecuencia" required>
                        <option value="√önico">√önico</option>
                        <option value="Mensual" selected>Mensual</option>
                        <option value="Quincenal">Quincenal</option>
                        <option value="Semanal">Semanal</option>
                    </select>
                </div>
                
                <!-- C√°lculo Autom√°tico -->
                <div class="calculation-box" id="ingresoCalculo">
                    <div class="calculation-row">
                        <span>Monto Bruto:</span>
                        <strong id="displayBruto">$0</strong>
                    </div>
                    <div class="calculation-row">
                        <span>Descuento:</span>
                        <strong style="color: var(--danger);" id="displayDescuento">-$0</strong>
                    </div>
                    <div class="calculation-row total">
                        <span>Monto Neto:</span>
                        <strong style="color: var(--secondary);" id="displayNeto">$0</strong>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top: 1rem;">Guardar Ingreso</button>
            </form>
        </div>
    </div>

    <!-- Add Fixed Expense Modal -->
    <div class="modal" id="addGastoFijoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìå Agregar Gasto Fijo</h2>
                <button class="close-btn" onclick="closeModal('addGastoFijoModal')">√ó</button>
            </div>
            <form onsubmit="addGastoFijo(event)">
                <div class="form-group">
                    <label class="form-label">Categor√≠a</label>
                    <select class="form-select" required>
                        <option>üè† Vivienda</option>
                        <option>üí° Servicios</option>
                        <option>üçî Comida</option>
                        <option>üöó Transporte</option>
                        <option>üéÆ Entretenimiento</option>
                        <option>üëï Ropa</option>
                        <option>üíä Salud</option>
                        <option>üéì Educaci√≥n</option>
                        <option>üì¶ Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-input" placeholder="Ej: Arriendo, Netflix, Internet" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto (COP)</label>
                    <input type="number" class="form-input" placeholder="100000" required>
                </div>
                <div class="form-group">
                    <label class="form-label">D√≠a de Pago del Mes</label>
                    <input type="number" class="form-input" placeholder="5" min="1" max="31" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Recordatorio (d√≠as antes)</label>
                    <select class="form-select">
                        <option value="">Sin recordatorio</option>
                        <option value="1">1 d√≠a antes</option>
                        <option value="3">3 d√≠as antes</option>
                        <option value="5">5 d√≠as antes</option>
                        <option value="7">7 d√≠as antes</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar Gasto Fijo</button>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal" id="addCategoriaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üè∑Ô∏è Crear Categor√≠a</h2>
                <button class="close-btn" onclick="closeModal('addCategoriaModal')">√ó</button>
            </div>
            <form onsubmit="addCategoria(event)">
                <div class="form-group">
                    <label class="form-label">Emoji</label>
                    <input type="text" class="form-input" placeholder="üéØ" maxlength="2" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nombre de la Categor√≠a</label>
                    <input type="text" class="form-input" placeholder="Ej: Mascotas, Inversiones" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Crear Categor√≠a</button>
            </form>
        </div>
    </div>
    <!-- Add Deuda Modal -->
    <div class="modal" id="addDeudaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí≥ Registrar Deuda</h2>
                <button class="close-btn" onclick="closeModal('addDeudaModal')">√ó</button>
            </div>
            <form onsubmit="addDeuda(event)">
                <div class="form-group">
                    <label class="form-label">Tipo de Deuda</label>
                    <select class="form-select" id="deudaTipo" required>
                        <option value="Tarjeta de Cr√©dito">üí≥ Tarjeta de Cr√©dito</option>
                        <option value="Pr√©stamo Bancario">üè¶ Pr√©stamo Bancario</option>
                        <option value="Pr√©stamo Personal">üë§ Pr√©stamo Personal</option>
                        <option value="Cr√©dito de Libranza">üìÑ Cr√©dito de Libranza</option>
                        <option value="Otro">üì¶ Otro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nombre/Descripci√≥n</label>
                    <input type="text" class="form-input" id="deudaNombre" placeholder="Ej: Visa, Pr√©stamo Carro" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Monto Total</label>
                        <input type="number" class="form-input" id="deudaMonto" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tasa (%)</label>
                        <input type="number" class="form-input" id="deudaTasa" placeholder="0" step="0.01">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">N√∫mero de Cuotas</label>
                        <input type="number" class="form-input" id="deudaCuotas" placeholder="12" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">D√≠a de Pago</label>
                        <input type="number" class="form-input" id="deudaDiaPago" placeholder="5" min="1" max="31" required>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width:100%">Registrar Deuda</button>
            </form>
        </div>
    </div>

    <!-- Set Budget Modal -->
    <div class="modal" id="setBudgetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∞ Establecer Presupuesto de Mercado</h2>
                <button class="close-btn" onclick="closeModal('setBudgetModal')">√ó</button>
            </div>
            <form onsubmit="setMarketBudget(event)">
                <div class="form-group">
                    <label class="form-label">Presupuesto Mensual</label>
                    <input type="number" class="form-input" id="marketBudgetInput" placeholder="500000" required>
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
                        Este ser√° tu presupuesto de mercado para el mes actual
                    </p>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Establecer Presupuesto</button>
            </form>
        </div>
    </div>

    <!-- Add Compra Modal -->
    <div class="modal" id="addCompraModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üõí Registrar Compra</h2>
                <button class="close-btn" onclick="closeModal('addCompraModal')">√ó</button>
            </div>
            <form onsubmit="addCompra(event)">
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-input" id="compraDesc" placeholder="Ej: Compra del viernes" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto</label>
                    <input type="number" class="form-input" id="compraAmount" placeholder="150000" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <input type="date" class="form-input" id="compraDate" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Registrar Compra</button>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal" id="confirmDeleteModal">
        <div class="confirm-dialog">
            <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
            <p id="deleteMessage">¬øEst√°s seguro de eliminar este registro?</p>
            <p style="font-size: 0.85rem; color: var(--text-light);" id="deleteWarning">
                Esta acci√≥n no se puede deshacer.
            </p>
            <div class="confirm-dialog-actions">
                <button class="btn btn-secondary" onclick="closeModal('confirmDeleteModal')">Cancelar</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- =============== JAVASCRIPT =============== -->
    <script>
        // SUPABASE CONFIGURATION
        const SUPABASE_URL = 'https://ctppigfvvqyizvzqfvzz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0cHBpZ2Z2dnF5aXp2enFmdnp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDkzNDcsImV4cCI6MjA4NDg4NTM0N30.er70gArSteC92YMwk6GS7rD8EKlAKrrRn25vqtJRLas';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let currentMonth = new Date();
        let trendChart = null

        // INIT
       async function init() {
            console.log('=== Iniciando Presupuesta2 v3 ===');
            
            try {
                const { data, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('Error al verificar sesi√≥n:', error);
                    return;
                }
                
                if (data?.session) {
                    currentUser = data.session.user;
                    console.log('Usuario autenticado:', currentUser.email);
                    showApp();
                } else {
                    console.log('No hay sesi√≥n activa');
                }
            } catch (error) {
                console.error('Error en init:', error);
            }
            
            // Load theme
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                const toggle = document.getElementById('darkModeToggle');
                if (toggle) toggle.checked = true;
            }
            
            // Set today's date in forms
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) input.value = today;
            });
        }

        // AUTH FUNCTIONS
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('recoveryForm').style.display = 'none';
            document.getElementById('authMessage').className = 'auth-message';
            
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
            } else if (tab === 'register') {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('registerForm').style.display = 'block';
            }
        }

        function showPasswordRecovery() {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('recoveryForm').style.display = 'block';
            document.getElementById('authMessage').className = 'auth-message';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                currentUser = data.user;
                showApp();
                
            } catch (error) {
                showAuthMessage(error.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: { data: { name } }
                });
                
                if (error) throw error;
                
                showAuthMessage('‚úÖ Cuenta creada. Por favor verifica tu email.', 'success');
                setTimeout(() => showAuthTab('login'), 3000);
                
            } catch (error) {
                showAuthMessage(error.message, 'error');
            }
        }

        async function handlePasswordRecovery(e) {
            e.preventDefault();
            const email = document.getElementById('recoveryEmail').value;
            
            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin
                });
                
                if (error) throw error;
                
                showAuthMessage('‚úÖ Enlace de recuperaci√≥n enviado a tu email.', 'success');
                setTimeout(() => showAuthTab('login'), 3000);
                
            } catch (error) {
                showAuthMessage(error.message, 'error');
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        function showAuthMessage(message, type) {
            const msg = document.getElementById('authMessage');
            msg.textContent = message;
            msg.className = `auth-message ${type}`;
        }

        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            
            const userName = currentUser.user_metadata?.name || 'Usuario';
            document.getElementById('userName').textContent = userName;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userNameInput').value = userName;
            
            loadPreferences();
            populateMonthSelector();
            updateCicloDisplay();
            loadAllData();
        }

        // NAVIGATION
        function showPage(pageId, element) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(pageId).classList.add('active');
            if (element) element.classList.add('active');
        }

        // SETTINGS
        function openSettings() {
            document.getElementById('settingsSidebar').classList.add('active');
            document.getElementById('sidebarOverlay').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsSidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        function toggleSection(id) {
            const content = document.getElementById(id + '-content');
            const arrow = document.getElementById(id + '-arrow');
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        // MODAL FUNCTIONS
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.modal').forEach(m => {
                m.addEventListener('click', e => {
                    if(e.target === m) m.classList.remove('active');
                });
            });
        });

        // =============== FORM SUBMIT FUNCTIONS ===============

        async function addIngreso(e) {
            e.preventDefault();
            
            const fuente = document.getElementById('ingresoFuente').value;
            const tipo = document.getElementById('ingresoTipo').value;
            const montoBruto = parseFloat(document.getElementById('ingresoBruto').value);
            const frecuencia = document.getElementById('ingresoFrecuencia').value;
            
            let porcentajeDescuento = 0;
            if (tipo === 'laboral') porcentajeDescuento = 0.08;
            else if (tipo === 'servicios') porcentajeDescuento = 0.285;
            else porcentajeDescuento = 0;
            
            const descuento = montoBruto * porcentajeDescuento;
            const montoNeto = montoBruto - descuento;
            
            try {
                const { data, error } = await supabaseClient
                    .from('incomes')
                    .insert([{
                        user_id: currentUser.id,
                        space_id: null,
                        source: fuente,
                        type: tipo,
                        frequency: frecuencia,
                        gross_amount: montoBruto,
                        net_amount: montoNeto,
                    }]);
                
                if (error) throw error;
                
                alert('‚úÖ Ingreso agregado exitosamente');
                closeModal('addIngresoModal');
                e.target.reset();
                document.getElementById('ingresoCalculo').style.display = 'none';
                
                loadIngresos();
                updateDashboard();
                
            } catch (error) {
                alert('‚ùå Error al guardar: ' + error.message);
                console.error('Error:', error);
            }
        }

        function updateIngresoCalculation() {
            const tipo = document.getElementById('ingresoTipo')?.value;
            const montoBruto = parseFloat(document.getElementById('ingresoBruto')?.value) || 0;
            
            if (montoBruto === 0) {
                const calculoBox = document.getElementById('ingresoCalculo');
                if (calculoBox) calculoBox.style.display = 'none';
                return;
            }
            
            let porcentajeDescuento = 0;
            if (tipo === 'laboral') porcentajeDescuento = 0.08;
            else if (tipo === 'servicios') porcentajeDescuento = 0.285;
            
            const descuento = montoBruto * porcentajeDescuento;
            const montoNeto = montoBruto - descuento;
            
            const calculoBox = document.getElementById('ingresoCalculo');
            const displayBruto = document.getElementById('displayBruto');
            const displayDescuento = document.getElementById('displayDescuento');
            const displayNeto = document.getElementById('displayNeto');
            
            if (calculoBox) calculoBox.style.display = 'block';
            if (displayBruto) displayBruto.textContent = `$${montoBruto.toLocaleString('es-CO')}`;
            if (displayDescuento) displayDescuento.textContent = `-$${descuento.toLocaleString('es-CO')} (${(porcentajeDescuento * 100)}%)`;
            if (displayNeto) displayNeto.textContent = `$${montoNeto.toLocaleString('es-CO')}`;
        }

        async function addQuickExpense(e) {
            e.preventDefault();
            
            const form = e.target;
            const monto = parseFloat(form.querySelectorAll('input')[0].value);
            const categoria = form.querySelector('select').value;
            const descripcion = form.querySelectorAll('input')[1].value;
            
            try {
                const { data, error } = await supabaseClient
                    .from('variable_expenses')
                    .insert([{
                        user_id: currentUser.id,
                        space_id: null,
                        category: categoria,
                        description: descripcion || 'Sin descripci√≥n',
                        amount: monto,
                        expense_date: new Date().toISOString().split('T')[0]
                    }]);
                
                if (error) throw error;
                
                alert('‚úÖ Gasto agregado exitosamente');
                closeModal('quickAddModal');
                form.reset();
                
                loadGastosVariables();
                updateDashboard();
                
            } catch (error) {
                alert('‚ùå Error al guardar: ' + error.message);
                console.error('Error:', error);
            }
        }

        async function addGastoFijo(e) {
            e.preventDefault();
            
            const form = e.target;
            const categoria = form.querySelectorAll('select')[0].value;
            const descripcion = form.querySelectorAll('input')[0].value;
            const monto = parseFloat(form.querySelectorAll('input')[1].value);
            const diaPago = parseInt(form.querySelectorAll('input')[2].value);
            const recordatorio = form.querySelectorAll('select')[1].value;
            
            try {
                const { data, error } = await supabaseClient
                    .from('fixed_expenses')
                    .insert([{
                        user_id: currentUser.id,
                        space_id: null,
                        category: categoria,
                        description: descripcion,
                        amount: monto,
                        payment_day: diaPago,
                        reminder_days: recordatorio ? parseInt(recordatorio) : null,
                        is_paid: false
                    }]);
                
                if (error) throw error;
                
                alert('‚úÖ Gasto fijo agregado exitosamente');
                closeModal('addGastoFijoModal');
                form.reset();
                
                loadGastosFijos();
                updateDashboard();
                
            } catch (error) {
                alert('‚ùå Error al guardar: ' + error.message);
                console.error('Error:', error);
            }
        }

        async function addCategoria(e) {
            e.preventDefault();
            
            const form = e.target;
            const emoji = form.querySelectorAll('input')[0].value;
            const nombre = form.querySelectorAll('input')[1].value;
            
            try {
                const { data, error } = await supabaseClient
                    .from('custom_categories')
                    .insert([{
                        user_id: currentUser.id,
                        space_id: null,
                        emoji: emoji,
                        name: nombre
                    }]);
                
                if (error) throw error;
                
                alert('‚úÖ Categor√≠a creada exitosamente');
                closeModal('addCategoriaModal');
                form.reset();
                
            } catch (error) {
                alert('‚ùå Error al guardar: ' + error.message);
                console.error('Error:', error);
            }
        }

        // =============== LOAD DATA FUNCTIONS ===============

        async function loadIngresos() {
            try {
                const { data, error } = await supabaseClient
                    .from('incomes')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const ingresosPage = document.getElementById('ingresos');
                const emptyState = ingresosPage.querySelector('.empty-state');
                
                if (data && data.length > 0) {
                    if (emptyState) emptyState.style.display = 'none';
                    
                    let table = ingresosPage.querySelector('.ingresos-table');
                    if (!table) {
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = '<table class="ingresos-table" style="width:100%; border-collapse: collapse;"></table>';
                        emptyState.parentNode.insertBefore(card, emptyState);
                        table = card.querySelector('table');
                    }
                    
                    let html = `
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 1rem; text-align: left;">Fuente</th>
                                <th style="padding: 1rem; text-align: left;">Frecuencia</th>
                                <th style="padding: 1rem; text-align: right;">Monto</th>
                                <th style="padding: 1rem; text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    let totalIngresos = 0;
                    
                    data.forEach(ingreso => {
                        totalIngresos += parseFloat(ingreso.net_amount || 0);
                        
                        const bruto = parseFloat(ingreso.gross_amount || 0);
                        const neto = parseFloat(ingreso.net_amount || 0);
                        const tipoLabel = ingreso.type === 'laboral' ? 'üíº' : ingreso.type === 'servicios' ? 'üí∞' : 'üéÅ';
                        
                        html += `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 1rem;">
                                    <div style="font-weight: 600;">${ingreso.source}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">${tipoLabel} ${ingreso.type}</div>
                                </td>
                                <td style="padding: 1rem;">${ingreso.frequency}</td>
                                <td style="padding: 1rem; text-align: right;">
                                    <div style="font-weight: 600; color: var(--secondary);">$${neto.toLocaleString('es-CO')}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">Bruto: $${bruto.toLocaleString('es-CO')}</div>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <button class="btn btn-danger btn-icon" onclick="confirmDelete('income', '${ingreso.id}', '${ingreso.source}')">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                        </tbody>
                        <tfoot>
                            <tr style="border-top: 2px solid var(--border); font-weight: 700;">
                                <td colspan="2" style="padding: 1rem;">TOTAL MENSUAL NETO</td>
                                <td style="padding: 1rem; text-align: right; color: var(--secondary);">
                                    $${totalIngresos.toLocaleString('es-CO')}
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    `;
                    
                    table.innerHTML = html;
                    
                } else {
                    if (emptyState) emptyState.style.display = 'block';
                    const existingTable = ingresosPage.querySelector('.card table');
                    if (existingTable) existingTable.parentElement.remove();
                }
                
            } catch (error) {
                console.error('Error al cargar ingresos:', error);
            }
        }

        async function loadGastosFijos() {
            try {
                const { data, error } = await supabaseClient
                    .from('fixed_expenses')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('payment_day', { ascending: true });
                
                if (error) throw error;
                
                const gastosFijosPage = document.getElementById('gastos-fijos');
                const emptyState = gastosFijosPage.querySelector('.empty-state');
                
                if (data && data.length > 0) {
                    if (emptyState) emptyState.style.display = 'none';
                    
                    let table = gastosFijosPage.querySelector('.gastos-fijos-table');
                    if (!table) {
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = '<table class="gastos-fijos-table" style="width:100%; border-collapse: collapse;"></table>';
                        emptyState.parentNode.insertBefore(card, emptyState);
                        table = card.querySelector('table');
                    }
                    
                    let html = `
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 1rem; text-align: left;">Descripci√≥n</th>
                                <th style="padding: 1rem; text-align: left;">Categor√≠a</th>
                                <th style="padding: 1rem; text-align: center;">D√≠a de Pago</th>
                                <th style="padding: 1rem; text-align: right;">Monto</th>
                                <th style="padding: 1rem; text-align: center;">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    let totalGastosFijos = 0;
                    
                    data.forEach(gasto => {
                        totalGastosFijos += parseFloat(gasto.amount || 0);
                        const estado = gasto.is_paid ? 
                            '<span class="badge badge-success">‚úì Pagado</span>' : 
                            '<span class="badge badge-primary">‚è≥ Pendiente</span>';
                        
                        html += `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 1rem; font-weight: 600;">${gasto.description}</td>
                                <td style="padding: 1rem;">${gasto.category}</td>
                                <td style="padding: 1rem; text-align: center;">${gasto.payment_day}</td>
                                <td style="padding: 1rem; text-align: right; font-weight: 600; color: var(--danger);">
                                    $${parseFloat(gasto.amount).toLocaleString('es-CO')}
                                </td>
                                <td style="padding: 1rem; text-align: center;">${estado}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                        </tbody>
                        <tfoot>
                            <tr style="border-top: 2px solid var(--border); font-weight: 700;">
                                <td colspan="3" style="padding: 1rem;">TOTAL MENSUAL</td>
                                <td style="padding: 1rem; text-align: right; color: var(--danger);">
                                    $${totalGastosFijos.toLocaleString('es-CO')}
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    `;
                    
                    table.innerHTML = html;
                    
                } else {
                    if (emptyState) emptyState.style.display = 'block';
                    const existingTable = gastosFijosPage.querySelector('.card table');
                    if (existingTable) existingTable.parentElement.remove();
                }
                
            } catch (error) {
                console.error('Error al cargar gastos fijos:', error);
            }
        }

        async function loadGastosVariables() {
            try {
                const { data, error } = await supabaseClient
                    .from('variable_expenses')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('expense_date', { ascending: false });
                
                if (error) throw error;
                
                const gastosVariablesPage = document.getElementById('gastos-variables');
                const emptyState = gastosVariablesPage.querySelector('.empty-state');
                
                if (data && data.length > 0) {
                    if (emptyState) emptyState.style.display = 'none';
                    
                    let table = gastosVariablesPage.querySelector('.gastos-variables-table');
                    if (!table) {
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = '<table class="gastos-variables-table" style="width:100%; border-collapse: collapse;"></table>';
                        emptyState.parentNode.insertBefore(card, emptyState);
                        table = card.querySelector('table');
                    }
                    
                    let html = `
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 1rem; text-align: left;">Descripci√≥n</th>
                                <th style="padding: 1rem; text-align: left;">Categor√≠a</th>
                                <th style="padding: 1rem; text-align: center;">Fecha</th>
                                <th style="padding: 1rem; text-align: right;">Monto</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    let totalGastosVariables = 0;
                    
                    data.forEach(gasto => {
                        totalGastosVariables += parseFloat(gasto.amount || 0);
                        const fecha = new Date(gasto.expense_date).toLocaleDateString('es-CO', { 
                            day: 'numeric', 
                            month: 'short',
                            year: 'numeric'
                        });
                        
                        html += `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 1rem; font-weight: 600;">${gasto.description}</td>
                                <td style="padding: 1rem;">${gasto.category}</td>
                                <td style="padding: 1rem; text-align: center;">${fecha}</td>
                                <td style="padding: 1rem; text-align: right; font-weight: 600; color: var(--danger);">
                                    $${parseFloat(gasto.amount).toLocaleString('es-CO')}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                        </tbody>
                        <tfoot>
                            <tr style="border-top: 2px solid var(--border); font-weight: 700;">
                                <td colspan="3" style="padding: 1rem;">TOTAL</td>
                                <td style="padding: 1rem; text-align: right; color: var(--danger);">
                                    $${totalGastosVariables.toLocaleString('es-CO')}
                                </td>
                            </tr>
                        </tfoot>
                    `;
                    
                    table.innerHTML = html;
                    
                } else {
                    if (emptyState) emptyState.style.display = 'block';
                    const existingTable = gastosVariablesPage.querySelector('.card table');
                    if (existingTable) existingTable.parentElement.remove();
                }
                
            } catch (error) {
                console.error('Error al cargar gastos variables:', error);
            }
        }

        // =============== DASHBOARD UPDATE ===============

        async function updateDashboard() {
            try {
                const [ingresosData, gastosFijosData, gastosVariablesData] = await Promise.all([
                    supabaseClient.from('incomes').select('*').eq('user_id', currentUser.id),
                    supabaseClient.from('fixed_expenses').select('*').eq('user_id', currentUser.id),
                    supabaseClient.from('variable_expenses').select('*').eq('user_id', currentUser.id)
                ]);
                
                const totalGastos = totalGastosFijos + totalGastosVariables;
                const totalPagado = (gastosFijosData.data || []).filter(g => g.is_paid).reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
                const totalPendiente = totalGastosFijos - totalPagado;
                
                // Calcular pagados y pendientes
                const totalPagado = (gastosFijosData.data || [])
                    .filter(g => g.is_paid)
                    .reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
                const totalPendiente = totalGastosFijos - totalPagado;
                
                // Balance Principal
                const balanceAmount = document.getElementById('balanceAmount');
                if (balanceAmount) {
                    balanceAmount.textContent = `$${balance.toLocaleString('es-CO')}`;
                    const balanceCard = document.querySelector('.balance-card');
                    if (balance < 0) {
                        balanceCard.style.background = 'linear-gradient(135deg, var(--danger), #DC2626)';
                    } else {
                        balanceCard.style.background = 'linear-gradient(135deg, var(--secondary), #059669)';
                    }
                }
                
                // Resumen Principal
                document.getElementById('dashBudget').textContent = `$${totalIngresos.toLocaleString('es-CO')}`;
                document.getElementById('dashIncomes').textContent = `$${totalIngresos.toLocaleString('es-CO')}`;
                document.getElementById('dashExpenses').textContent = `$${totalGastos.toLocaleString('es-CO')}`;
                document.getElementById('dashPaid').textContent = `$${totalPagado.toLocaleString('es-CO')}`;
                document.getElementById('dashPending').textContent = `$${totalPendiente.toLocaleString('es-CO')}`;
                
                // Pr√≥ximos Pagos
                updateUpcomingPayments(gastosFijosData.data || []);
                
            } catch (error) {
                console.error('Error al actualizar dashboard:', error);
            }
        }

        function updateUpcomingPayments(gastosFijos) {
            const container = document.getElementById('upcomingPayments');
            const today = new Date().getDate();
            
            // Filtrar pr√≥ximos 5 d√≠as
            const upcoming = gastosFijos
                .filter(g => !g.is_paid && g.payment_day >= today && g.payment_day <= today + 5)
                .sort((a, b) => a.payment_day - b.payment_day)
                .slice(0, 5);
            
            if (upcoming.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <p>No hay pagos pr√≥ximos en los pr√≥ximos 5 d√≠as</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            upcoming.forEach(gasto => {
                const daysLeft = gasto.payment_day - today;
                const daysText = daysLeft === 0 ? 'Hoy' : `En ${daysLeft} d√≠a${daysLeft > 1 ? 's' : ''}`;
                
                html += `
                    <div class="payment-item">
                        <div class="payment-info">
                            <div class="payment-name">${gasto.description}</div>
                            <div class="payment-date">${gasto.category} ‚Ä¢ ${daysText}</div>
                        </div>
                        <div class="payment-amount" style="color: var(--danger);">
                            $${parseFloat(gasto.amount).toLocaleString('es-CO')}
                        </div>
                        <div class="payment-status">
                            <span class="badge badge-warning">‚è≥ Pendiente</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // THEME FUNCTIONS
        function toggleDarkMode() {
            const dark = document.getElementById('darkModeToggle').checked;
            if(dark) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            }
        }

        // PREFERENCES FUNCTIONS
        async function savePreferences() {
            const moneda = document.getElementById('monedaSelect').value;
            const ciclo = parseInt(document.getElementById('cicloInput').value);
            
            if (ciclo < 1 || ciclo > 31) {
                alert('‚ùå El d√≠a del ciclo debe estar entre 1 y 31');
                return;
            }
            
            try {
                localStorage.setItem('moneda', moneda);
                localStorage.setItem('ciclo_inicio', ciclo);
                
                const { error } = await supabaseClient
                    .from('users')
                    .update({
                        preferences: {
                            moneda: moneda,
                            ciclo_inicio: ciclo
                        }
                    })
                    .eq('id', currentUser.id);
                
                if (error) console.log('No se pudo guardar en DB:', error);
                
                alert('‚úÖ Preferencias guardadas exitosamente');
                updateCicloDisplay();
                
            } catch (error) {
                console.error('Error al guardar preferencias:', error);
                alert('‚ö†Ô∏è Preferencias guardadas localmente');
            }
        }

        function loadPreferences() {
            const moneda = localStorage.getItem('moneda') || 'COP';
            const monedaSelect = document.getElementById('monedaSelect');
            if (monedaSelect) monedaSelect.value = moneda;
            
            const ciclo = localStorage.getItem('ciclo_inicio') || '20';
            const cicloInput = document.getElementById('cicloInput');
            if (cicloInput) cicloInput.value = ciclo;
            
            updateCicloDisplay();
        }

        function updateCicloDisplay() {
            const cicloInicio = parseInt(localStorage.getItem('ciclo_inicio') || '20');
            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const a√±oActual = hoy.getFullYear();
            
            let fechaInicio, fechaFin;
            
            if (hoy.getDate() >= cicloInicio) {
                fechaInicio = new Date(a√±oActual, mesActual, cicloInicio);
                fechaFin = new Date(a√±oActual, mesActual + 1, cicloInicio - 1);
            } else {
                fechaInicio = new Date(a√±oActual, mesActual - 1, cicloInicio);
                fechaFin = new Date(a√±oActual, mesActual, cicloInicio - 1);
            }
            
            const opciones = { day: 'numeric', month: 'short', year: 'numeric' };
            const textoInicio = fechaInicio.toLocaleDateString('es-CO', opciones);
            const textoFin = fechaFin.toLocaleDateString('es-CO', opciones);
            
            const cicloDisplay = document.getElementById('cycleDisplay');
            if (cicloDisplay) {
                cicloDisplay.textContent = `Ciclo actual: ${textoInicio} - ${textoFin}`;
            }
        }

        // UPDATE USER NAME
        async function updateUserName() {
            const newName = document.getElementById('userNameInput').value.trim();
            
            if (!newName) {
                alert('‚ùå Por favor ingresa un nombre');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.updateUser({
                    data: { name: newName }
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                document.getElementById('userName').textContent = newName;
                
                try {
                    await supabaseClient
                        .from('users')
                        .update({ name: newName })
                        .eq('id', currentUser.id);
                } catch (dbError) {
                    console.log('Users table update skipped');
                }
                
                alert('‚úÖ Nombre actualizado exitosamente');
                
            } catch (error) {
                alert('‚ùå Error al actualizar: ' + error.message);
            }
        }
        // FORMAT CURRENCY
        function formatCurrency(amount) {
            return `$${parseFloat(amount || 0).toLocaleString('es-CO')}`;
        }

        // GET CURRENT PERIOD
        function getCurrentPeriod() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            return {
                year,
                month: month + 1,
                key: `${year}-${String(month + 1).padStart(2, '0')}`
            };
        }

        // Initialize app
        init();
    </script>
</body>
</html>
