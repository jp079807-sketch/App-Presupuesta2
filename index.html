<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuesta2 - Finanzas en Pareja</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #4F46E5;
            --primary-light: #6366F1;
            --secondary: #10B981;
            --danger: #EF4444;
            --bg: #F9FAFB;
            --card: #FFFFFF;
            --text: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
        }
        
        [data-theme="dark"] {
            --primary: #6366F1;
            --primary-light: #818CF8;
            --secondary: #10B981;
            --danger: #EF4444;
            --bg: #111827;
            --card: #1F2937;
            --text: #F9FAFB;
            --text-light: #9CA3AF;
            --border: #374151;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            transition: all 0.3s; 
        }
        
        /* === AUTH STYLES === */
        .auth-container { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
        }
        
        .auth-card { 
            background: var(--card); 
            padding: 2.5rem; 
            border-radius: 20px; 
            max-width: 420px; 
            width: 100%; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        
        .auth-logo { 
            text-align: center; 
            margin-bottom: 2rem; 
        }
        
        .auth-logo h1 { 
            font-size: 2.5rem; 
            margin-bottom: 0.5rem;
        }
        
        .auth-logo p { 
            color: var(--text-light); 
            font-size: 0.95rem;
        }
        
        .auth-tabs { 
            display: flex; 
            gap: 0.5rem; 
            margin-bottom: 2rem;
            background: var(--bg);
            padding: 0.25rem;
            border-radius: 12px;
        }
        
        .auth-tab { 
            flex: 1; 
            padding: 0.75rem; 
            border: none; 
            background: transparent;
            border-radius: 10px; 
            font-weight: 600; 
            cursor: pointer;
            color: var(--text);
            transition: all 0.2s;
        }
        
        .auth-tab.active { 
            background: var(--card); 
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .auth-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
            display: none;
        }
        
        .auth-message.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            display: block;
        }
        
        .auth-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
            display: block;
        }
        
        /* === MAIN APP STYLES === */
        .app { 
            display: none; 
        }
        
        .app.active { 
            display: block; 
        }
        
        .header { 
            background: linear-gradient(135deg, var(--primary), var(--primary-light)); 
            color: white; 
            padding: 1.5rem; 
            position: sticky; 
            top: 0; 
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .logo { 
            font-size: 1.5rem; 
            font-weight: 700; 
        }
        
        .user-menu { 
            display: flex; 
            gap: 1rem; 
            align-items: center; 
        }
        
        .space-selector { 
            background: rgba(255,255,255,0.2); 
            padding: 0.5rem 1rem; 
            border-radius: 8px; 
            border: none; 
            color: white; 
            cursor: pointer;
            font-weight: 500;
        }
        
        .space-selector option {
            color: var(--text);
        }
        
        .settings-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .nav-menu { 
            display: flex; 
            gap: 1rem; 
            padding: 1rem; 
            background: var(--card); 
            overflow-x: auto; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--border);
        }
        
        .nav-menu::-webkit-scrollbar {
            height: 6px;
        }
        
        .nav-menu::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .nav-item { 
            padding: 0.5rem 1rem; 
            border-radius: 8px; 
            cursor: pointer; 
            white-space: nowrap; 
            font-weight: 500; 
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .nav-item:hover { 
            background: var(--bg);
            border-color: var(--border);
        }
        
        .nav-item.active { 
            background: var(--primary); 
            color: white;
            border-color: var(--primary);
        }
        
        .dashboard { 
            padding: 2rem; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .page { 
            display: none; 
        }
        
        .page.active { 
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .welcome h1 { 
            font-size: 1.8rem; 
            margin-bottom: 0.5rem; 
        }
        
        .welcome p { 
            color: var(--text-light); 
        }
        
        .balance-card { 
            background: linear-gradient(135deg, var(--secondary), #059669); 
            color: white; 
            padding: 2rem; 
            border-radius: 16px; 
            margin: 2rem 0; 
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
        }
        
        .balance-label { 
            font-size: 0.9rem; 
            opacity: 0.9; 
            margin-bottom: 0.5rem; 
        }
        
        .balance-amount { 
            font-size: 2.5rem; 
            font-weight: 700; 
        }
        
        .grid { 
            display: grid; 
            gap: 1.5rem; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            margin-bottom: 2rem; 
        }
        
        .card { 
            background: var(--card); 
            border-radius: 12px; 
            padding: 1.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1rem; 
        }
        
        .card-title { 
            font-size: 1.1rem; 
            font-weight: 600; 
        }
        
        .btn { 
            padding: 0.75rem 1.5rem; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        
        .btn-primary:hover { 
            background: #4338CA;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .btn-small { 
            padding: 0.5rem 1rem; 
            font-size: 0.9rem; 
        }
        
        .info-box { 
            background: rgba(79, 70, 229, 0.05); 
            border-left: 4px solid var(--primary); 
            padding: 1rem; 
            border-radius: 8px; 
            margin-bottom: 1rem; 
            font-size: 0.9rem; 
            color: var(--text-light); 
        }
        
        .empty-state { 
            text-align: center; 
            padding: 3rem; 
            color: var(--text-light); 
        }
        
        .empty-state-icon { 
            font-size: 4rem; 
            opacity: 0.5; 
            margin-bottom: 1rem; 
        }
        
        .fab { 
            position: fixed; 
            bottom: 2rem; 
            right: 2rem; 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, var(--primary), var(--primary-light)); 
            color: white; 
            border: none; 
            font-size: 2rem; 
            cursor: pointer; 
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.4); 
            z-index: 50; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.3s;
        }
        
        .fab:hover { 
            transform: scale(1.1) rotate(90deg); 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            align-items: center; 
            justify-content: center; 
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal.active { 
            display: flex;
            animation: fadeIn 0.3s;
        }
        
        .modal-content { 
            background: var(--card); 
            padding: 2rem; 
            border-radius: 16px; 
            max-width: 500px; 
            width: 90%; 
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 1.5rem; 
        }
        
        .modal-title { 
            font-size: 1.5rem; 
            font-weight: 600; 
        }
        
        .close-btn { 
            background: none; 
            border: none; 
            font-size: 1.5rem; 
            cursor: pointer; 
            color: var(--text-light);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: var(--bg);
            color: var(--text);
        }
        
        .form-group { 
            margin-bottom: 1rem; 
        }
        
        .form-label { 
            display: block; 
            margin-bottom: 0.5rem; 
            font-weight: 500; 
            font-size: 0.9rem; 
        }
        
        .form-input, .form-select { 
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid var(--border); 
            border-radius: 8px; 
            background: var(--card); 
            color: var(--text); 
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .form-input:focus, .form-select:focus { 
            outline: none; 
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .sidebar { 
            position: fixed; 
            right: -400px; 
            top: 0; 
            width: 400px; 
            height: 100vh; 
            background: var(--card); 
            box-shadow: -4px 0 20px rgba(0,0,0,0.1); 
            transition: right 0.3s; 
            z-index: 200; 
            overflow-y: auto; 
        }
        
        .sidebar.active { 
            right: 0; 
        }
        
        .sidebar-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            display: none; 
            z-index: 150;
            backdrop-filter: blur(4px);
        }
        
        .sidebar-overlay.active { 
            display: block; 
        }
        
        .sidebar-header { 
            padding: 1.5rem; 
            background: linear-gradient(135deg, var(--primary), var(--primary-light)); 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .sidebar-title { 
            font-size: 1.3rem; 
            font-weight: 600; 
        }
        
        .sidebar-content { 
            padding: 1rem; 
        }
        
        .sidebar-section { 
            margin-bottom: 0.5rem; 
            border-radius: 8px; 
            background: var(--bg); 
            overflow: hidden; 
        }
        
        .sidebar-section-header { 
            padding: 1rem; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            user-select: none;
            transition: all 0.2s;
        }
        
        .sidebar-section-header:hover { 
            background: var(--border); 
        }
        
        .sidebar-section-title { 
            font-size: 1rem; 
            font-weight: 600; 
        }
        
        .sidebar-section-arrow { 
            transition: transform 0.3s; 
        }
        
        .sidebar-section-arrow.open { 
            transform: rotate(180deg); 
        }
        
        .sidebar-section-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s; 
            padding: 0 1rem; 
        }
        
        .sidebar-section-content.open { 
            max-height: 1000px; 
            padding: 1rem; 
        }
        
        .toggle-switch { 
            position: relative; 
            display: inline-block; 
            width: 50px; 
            height: 26px; 
        }
        
        .toggle-switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        .toggle-slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: var(--border); 
            border-radius: 26px; 
            transition: 0.4s; 
        }
        
        .toggle-slider:before { 
            position: absolute; 
            content: ""; 
            height: 18px; 
            width: 18px; 
            left: 4px; 
            bottom: 4px; 
            background: white; 
            border-radius: 50%; 
            transition: 0.4s; 
        }
        
        input:checked + .toggle-slider { 
            background: var(--primary); 
        }
        
        input:checked + .toggle-slider:before { 
            transform: translateX(24px); 
        }
        
        .space-item { 
            padding: 1rem; 
            background: var(--card); 
            border: 2px solid var(--border); 
            border-radius: 8px; 
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        
        .space-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .badge { 
            padding: 0.5rem 1rem; 
            border-radius: 12px; 
            font-size: 0.9rem; 
            font-weight: 600; 
            display: inline-block; 
            margin: 0.25rem; 
        }
        
        .badge-primary { 
            background: rgba(79, 70, 229, 0.1); 
            color: var(--primary); 
        }
        
        .badge-success { 
            background: rgba(16, 185, 129, 0.1); 
            color: var(--secondary); 
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .stat-value {
            font-weight: 600;
            font-size: 1rem;
        }
        
        @media (max-width: 768px) {
            .sidebar { 
                width: 100%; 
                right: -100%; 
            }
            
            .dashboard { 
                padding: 1rem; 
            }
            
            .balance-amount { 
                font-size: 1.8rem; 
            }
            
            .grid { 
                grid-template-columns: 1fr; 
            }
            
            .fab { 
                bottom: 1rem; 
                right: 1rem; 
                width: 56px; 
                height: 56px; 
            }
            
            .auth-card {
                padding: 2rem;
            }
            
            .space-selector {
                max-width: 150px;
                font-size: 0.85rem;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- ============================================ -->
    <!-- AUTH SCREEN -->
    <!-- ============================================ -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <h1>üí∞ Presupuesta2</h1>
                <p>Gestiona tus finanzas personal y en pareja</p>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Iniciar Sesi√≥n</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Registrarse</button>
            </div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="tu@email.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Iniciar Sesi√≥n</button>
            </form>
            
            <form id="registerForm" style="display:none" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-input" id="registerName" placeholder="Tu nombre" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="registerEmail" placeholder="tu@email.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" class="form-input" id="registerPassword" placeholder="M√≠nimo 6 caracteres" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Crear Cuenta</button>
            </form>
            
            <div id="authMessage" class="auth-message"></div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- MAIN APP -->
    <!-- ============================================ -->
    <div id="mainApp" class="app">
        <header class="header">
            <div class="header-content">
                <div class="logo">üí∞ Presupuesta2</div>
                <div class="user-menu">
                    <select class="space-selector" id="spaceSelector">
                        <option value="personal">üë§ Personal</option>
                        <option value="pareja">üíë Con Pareja</option>
                    </select>
                    <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
                </div>
            </div>
        </header>

        <nav class="nav-menu">
            <div class="nav-item active" onclick="showPage('dashboard', this)">üìä Dashboard</div>
            <div class="nav-item" onclick="showPage('ingresos', this)">üíµ Ingresos</div>
            <div class="nav-item" onclick="showPage('gastos-fijos', this)">üìå Gastos Fijos</div>
            <div class="nav-item" onclick="showPage('gastos-variables', this)">üí∏ Gastos Variables</div>
            <div class="nav-item" onclick="showPage('categorias', this)">üè∑Ô∏è Categor√≠as</div>
        </nav>

        <main class="dashboard">
            <!-- ============================================ -->
            <!-- DASHBOARD PAGE -->
            <!-- ============================================ -->
            <div id="dashboard" class="page active">
                <div class="welcome">
                    <h1>Hola, <span id="userName">Usuario</span> üëã</h1>
                    <p>Ciclo actual: 20 Dic 2025 - 19 Ene 2026</p>
                </div>
                
                <div class="balance-card">
                    <div class="balance-label">Balance este mes</div>
                    <div class="balance-amount">$1.250.000</div>
                </div>
                
                <div class="grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí∞ Presupuestos</h3>
                        </div>
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>A√∫n no has creado presupuestos</p>
                            <button class="btn btn-primary btn-small" style="margin-top:1rem" onclick="alert('Pr√≥ximamente')">Crear Presupuesto</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí∏ √öltimos Gastos</h3>
                            <button class="btn btn-primary btn-small" onclick="openModal('quickAddModal')">+ Agregar</button>
                        </div>
                        <div class="empty-state">
                            <div class="empty-state-icon">üßæ</div>
                            <p>No hay gastos registrados este mes</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìà Resumen Mensual</h3>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Ingresos totales</span>
                        <span class="stat-value" style="color: var(--secondary)">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Gastos fijos</span>
                        <span class="stat-value">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Gastos variables</span>
                        <span class="stat-value">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Balance</span>
                        <span class="stat-value" style="color: var(--primary)">$0</span>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- INGRESOS PAGE -->
            <!-- ============================================ -->
            <div id="ingresos" class="page">
                <div class="card-header" style="margin-bottom: 1.5rem;">
                    <h2 class="card-title" style="font-size: 1.5rem;">üíµ Ingresos</h2>
                    <button class="btn btn-primary" onclick="openModal('addIngresoModal')">+ Agregar Ingreso</button>
                </div>
                
                <div class="info-box">
                    üìå Los ingresos pueden ser salarios, honorarios, rentas o cualquier entrada de dinero. Puedes configurar si son recurrentes o √∫nicos.
                </div>
                
                <div class="empty-state">
                    <div class="empty-state-icon">üí∞</div>
                    <p>A√∫n no has registrado ingresos</p>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">Agrega tu primer ingreso para comenzar</p>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- GASTOS FIJOS PAGE -->
            <!-- ============================================ -->
            <div id="gastos-fijos" class="page">
                <div class="card-header" style="margin-bottom: 1.5rem;">
                    <h2 class="card-title" style="font-size: 1.5rem;">üìå Gastos Fijos</h2>
                    <button class="btn btn-primary" onclick="openModal('addGastoFijoModal')">+ Agregar Gasto Fijo</button>
                </div>
                
                <div class="info-box">
                    üìå Los gastos fijos son aquellos que se repiten cada mes con el mismo monto (arriendo, Netflix, servicios, etc.). Puedes configurar recordatorios para no olvidar pagarlos.
                </div>
                
                <div class="empty-state">
                    <div class="empty-state-icon">üìÖ</div>
                    <p>No tienes gastos fijos registrados</p>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">Agrega tus gastos recurrentes para un mejor control</p>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- GASTOS VARIABLES PAGE -->
            <!-- ============================================ -->
            <div id="gastos-variables" class="page">
                <div class="card-header" style="margin-bottom: 1.5rem;">
                    <h2 class="card-title" style="font-size: 1.5rem;">üí∏ Gastos Variables</h2>
                    <button class="btn btn-primary" onclick="openModal('quickAddModal')">+ Agregar Gasto</button>
                </div>
                
                <div class="info-box">
                    üìå Los gastos variables son aquellos que cambian cada mes (comida, transporte, entretenimiento, etc.). Reg√≠stralos para saber en qu√© gastas tu dinero.
                </div>
                
                <div class="empty-state">
                    <div class="empty-state-icon">üõí</div>
                    <p>No hay gastos variables este mes</p>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">Empieza a registrar tus gastos diarios</p>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- CATEGOR√çAS PAGE -->
            <!-- ============================================ -->
            <div id="categorias" class="page">
                <div class="card-header" style="margin-bottom: 1.5rem;">
                    <h2 class="card-title" style="font-size: 1.5rem;">üè∑Ô∏è Categor√≠as</h2>
                    <button class="btn btn-primary" onclick="openModal('addCategoriaModal')">+ Crear Categor√≠a</button>
                </div>
                
                <div class="info-box">
                    üìå Las categor√≠as te ayudan a organizar tus gastos. Puedes usar las predefinidas o crear las tuyas propias.
                </div>
                
                <div class="grid">
                    <div class="card">
                        <h3 class="card-title">Categor√≠as Predefinidas</h3>
                        <div style="margin-top: 1rem;">
                            <span class="badge badge-primary">üè† Vivienda</span>
                            <span class="badge badge-primary">üí° Servicios</span>
                            <span class="badge badge-primary">üçî Comida</span>
                            <span class="badge badge-primary">üöó Transporte</span>
                            <span class="badge badge-primary">üéÆ Entretenimiento</span>
                            <span class="badge badge-primary">üëï Ropa</span>
                            <span class="badge badge-primary">üíä Salud</span>
                            <span class="badge badge-primary">üéì Educaci√≥n</span>
                            <span class="badge badge-primary">üì¶ Otros</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Categor√≠as Personalizadas</h3>
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ú®</div>
                            <p style="font-size: 0.9rem;">Crea categor√≠as personalizadas para tus necesidades</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- FAB Button -->
        <button class="fab" onclick="openModal('quickAddModal')">+</button>
    </div>

    <!-- ============================================ -->
    <!-- SIDEBAR (SETTINGS) -->
    <!-- ============================================ -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSettings()"></div>
    <div class="sidebar" id="settingsSidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">‚öôÔ∏è Configuraci√≥n</h2>
            <button class="close-btn" onclick="closeSettings()" style="color: white;">√ó</button>
        </div>
        <div class="sidebar-content">
            <!-- User Info -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('user')">
                    <span class="sidebar-section-title">üë§ Usuario</span>
                    <span class="sidebar-section-arrow" id="user-arrow">‚ñº</span>
                </div>
                <div class="sidebar-section-content" id="user-content">
    <p style="margin-bottom: 0.5rem;"><strong>Email:</strong> <span id="userEmail">-</span></p>
    <div style="margin-bottom: 1rem;">
        <label class="form-label">Nombre</label>
        <input type="text" class="form-input" id="userNameInput" placeholder="Tu nombre">
        <button class="btn btn-primary btn-small" style="margin-top: 0.5rem;" onclick="updateUserName()">üíæ Guardar Nombre</button>
    </div>
    <button class="btn btn-primary" style="width: 100%;" onclick="handleLogout()">üö™ Cerrar Sesi√≥n</button>
</div>
            </div>

            <!-- Spaces -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('spaces')">
                    <span class="sidebar-section-title">üíë Espacios Compartidos</span>
                    <span class="sidebar-section-arrow" id="spaces-arrow">‚ñº</span>
                </div>
                <div class="sidebar-section-content" id="spaces-content">
                    <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem;">Crea espacios para manejar finanzas en pareja o familia</p>
                    
                    <div class="space-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">üë§ Personal</div>
                                <div style="font-size: 0.85rem; color: var(--text-light);">Solo t√∫</div>
                            </div>
                            <span class="badge badge-success">Activo</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="openModal('inviteModal')">+ Crear Espacio Compartido</button>
                </div>
            </div>

            <!-- Preferences -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('preferences')">
                    <span class="sidebar-section-title">üé® Preferencias</span>
                    <span class="sidebar-section-arrow" id="preferences-arrow">‚ñº</span>
                </div>
                <div class="sidebar-section-content" id="preferences-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <span>üåô Modo Oscuro</span>
        <label class="toggle-switch">
            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
            <span class="toggle-slider"></span>
        </label>
    </div>
    
    <div style="margin-bottom: 1rem;">
        <label class="form-label">üí∞ Moneda</label>
        <select class="form-select" id="monedaSelect">
            <option value="COP">COP - Peso Colombiano</option>
            <option value="USD">USD - D√≥lar</option>
            <option value="EUR">EUR - Euro</option>
        </select>
    </div>
    
    <div style="margin-bottom: 1rem;">
        <label class="form-label">üìÖ D√≠a de Inicio del Ciclo</label>
        <input type="number" class="form-input" id="cicloInput" value="20" min="1" max="31">
        <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">El d√≠a del mes en que comienza tu ciclo de presupuesto</p>
    </div>
    
    <button class="btn btn-primary" style="width: 100%;" onclick="savePreferences()">üíæ Guardar Preferencias</button>
</div>

            <!-- About -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('about')">
                    <span class="sidebar-section-title">‚ÑπÔ∏è Acerca de</span>
                    <span class="sidebar-section-arrow" id="about-arrow">‚ñº</span>
                </div>
                <div class="sidebar-section-content" id="about-content">
                    <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>Presupuesta2</strong></p>
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem;">Versi√≥n 2.0.0</p>
                    <p style="font-size: 0.85rem; color: var(--text-light);">Una aplicaci√≥n para gestionar tus finanzas personales y en pareja de forma simple y efectiva.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- MODALS -->
    <!-- ============================================ -->
    
    <!-- Quick Add Expense Modal -->
    <div class="modal" id="quickAddModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∏ Agregar Gasto R√°pido</h2>
                <button class="close-btn" onclick="closeModal('quickAddModal')">√ó</button>
            </div>
            <form onsubmit="addQuickExpense(event)">
                <div class="form-group">
                    <label class="form-label">Monto (COP)</label>
                    <input type="number" class="form-input" placeholder="50000" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Categor√≠a</label>
                    <select class="form-select" required>
                        <option>üè† Vivienda</option>
                        <option>üí° Servicios</option>
                        <option>üçî Comida</option>
                        <option>üöó Transporte</option>
                        <option>üéÆ Entretenimiento</option>
                        <option>üëï Ropa</option>
                        <option>üíä Salud</option>
                        <option>üéì Educaci√≥n</option>
                        <option>üì¶ Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n (opcional)</label>
                    <input type="text" class="form-input" placeholder="Ej: Almuerzo, Uber, Netflix">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Agregar Gasto</button>
            </form>
        </div>
    </div>

    <!-- Add Income Modal -->
    <div class="modal" id="addIngresoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üíµ Agregar Ingreso</h2>
                <button class="close-btn" onclick="closeModal('addIngresoModal')">√ó</button>
            </div>
            <form onsubmit="addIngreso(event)">
                <div class="form-group">
                    <label class="form-label">Tipo de Ingreso</label>
                    <select class="form-select" required>
                        <option>üíº Salario</option>
                        <option>üí∞ Honorarios</option>
                        <option>üè† Renta</option>
                        <option>üìà Inversiones</option>
                        <option>üéÅ Bono</option>
                        <option>üì¶ Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-input" placeholder="Ej: Salario mensual, Proyecto freelance" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto (COP)</label>
                    <input type="number" class="form-input" placeholder="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Frecuencia</label>
                    <select class="form-select" required>
                        <option>√önico</option>
                        <option selected>Mensual</option>
                        <option>Quincenal</option>
                        <option>Semanal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha de Pago</label>
                    <input type="date" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Agregar Ingreso</button>
            </form>
        </div>
    </div>

    <!-- Add Fixed Expense Modal -->
    <div class="modal" id="addGastoFijoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìå Agregar Gasto Fijo</h2>
                <button class="close-btn" onclick="closeModal('addGastoFijoModal')">√ó</button>
            </div>
            <form onsubmit="addGastoFijo(event)">
                <div class="form-group">
                    <label class="form-label">Categor√≠a</label>
                    <select class="form-select" required>
                        <option>üè† Vivienda</option>
                        <option>üí° Servicios</option>
                        <option>üöó Transporte</option>
                        <option>üì¶ Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-input" placeholder="Ej: Arriendo, Netflix, Gimnasio" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto (COP)</label>
                    <input type="number" class="form-input" placeholder="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">D√≠a de Pago (1-31)</label>
                    <input type="number" class="form-input" placeholder="Ej: 1, 15, 25" min="1" max="31" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Recordatorio</label>
                    <select class="form-select">
                        <option value="">Sin recordatorio</option>
                        <option value="1">1 d√≠a antes</option>
                        <option value="3">3 d√≠as antes</option>
                        <option value="5">5 d√≠as antes</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Agregar Gasto Fijo</button>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal" id="addCategoriaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üè∑Ô∏è Crear Categor√≠a Personalizada</h2>
                <button class="close-btn" onclick="closeModal('addCategoriaModal')">√ó</button>
            </div>
            <form onsubmit="addCategoria(event)">
                <div class="form-group">
                    <label class="form-label">Emoji</label>
                    <input type="text" class="form-input" placeholder="üéØ" maxlength="2" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-input" placeholder="Ej: Mascotas, Gym, Inversiones" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Crear Categor√≠a</button>
            </form>
        </div>
    </div>

    <!-- Invite/Create Space Modal -->
    <div class="modal" id="inviteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üíë Crear Espacio Compartido</h2>
                <button class="close-btn" onclick="closeModal('inviteModal')">√ó</button>
            </div>
            <form onsubmit="sendInvite(event)">
                <div class="form-group">
                    <label class="form-label">Nombre del Espacio</label>
                    <input type="text" class="form-input" placeholder="Ej: Con Nahomy, Familia" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email para Invitar</label>
                    <input type="email" class="form-input" placeholder="pareja@email.com" required>
                </div>
                <div class="info-box">
                    üí° La persona recibir√° un correo para unirse a tu espacio compartido. Podr√°n ver y gestionar las finanzas juntos.
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Enviar Invitaci√≥n</button>
            </form>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- JAVASCRIPT -->
    <!-- ============================================ -->
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://ctppigfvvqyizvzqfvzz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0cHBpZ2Z2dnF5aXp2enFmdnp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDkzNDcsImV4cCI6MjA4NDg4NTM0N30.er70gArSteC92YMwk6GS7rD8EKlAKrrRn25vqtJRLas';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;

        // ============================================
        // AUTH FUNCTIONS
        // ============================================
        
        window.addEventListener('load', async () => {
            // Check if user is already logged in
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                showMainApp();
            }
            
            // Load saved theme
            if(localStorage.getItem('theme') === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                const toggle = document.getElementById('darkModeToggle');
                if (toggle) toggle.checked = true;
            }
        });

        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
            
            const authMsg = document.getElementById('authMessage');
            authMsg.className = 'auth-message';
            authMsg.textContent = '';
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const authMsg = document.getElementById('authMessage');
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                showMainApp();
                
            } catch (error) {
                authMsg.className = 'auth-message error';
                authMsg.textContent = 'Error: ' + error.message;
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const authMsg = document.getElementById('authMessage');
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({ 
                    email, 
                    password,
                    options: {
                        data: {
                            name: name
                        }
                    }
                });
                
                if (error) throw error;
                
                // Try to insert user data into users table
                try {
                    await supabaseClient.from('users').insert([{ 
                        id: data.user.id, 
                        email, 
                        name 
                    }]);
                } catch (dbError) {
                    console.log('User profile creation will be handled by database trigger');
                }
                
                currentUser = data.user;
                
                authMsg.className = 'auth-message success';
                authMsg.textContent = '‚úÖ Cuenta creada exitosamente. Revisa tu email para confirmar.';
                
                // Show main app after 2 seconds
                setTimeout(() => {
                    showMainApp();
                }, 2000);
                
            } catch (error) {
                authMsg.className = 'auth-message error';
                authMsg.textContent = 'Error: ' + error.message;
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

       function showMainApp() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('mainApp').classList.add('active');
    
    // Update user info
    const userName = currentUser.user_metadata?.name || currentUser.email.split('@')[0];
    document.getElementById('userName').textContent = userName;
    document.getElementById('userEmail').textContent = currentUser.email;
    document.getElementById('userNameInput').value = userName;

           // Cargar preferencias
    loadPreferences();
           
    // Cargar datos
    loadIngresos();
    loadGastosFijos();
    loadGastosVariables();
    loadCategorias();
    updateDashboard();
}
        
        // ============================================
        // NAVIGATION FUNCTIONS
        // ============================================
        
        function showPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) el.classList.add('active');
        }

        // ============================================
        // SETTINGS SIDEBAR FUNCTIONS
        // ============================================
        
        function openSettings() {
            document.getElementById('settingsSidebar').classList.add('active');
            document.getElementById('sidebarOverlay').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsSidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        function toggleSection(id) {
            const content = document.getElementById(id + '-content');
            const arrow = document.getElementById(id + '-arrow');
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Close modal on outside click
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.modal').forEach(m => {
                m.addEventListener('click', e => {
                    if(e.target === m) m.classList.remove('active');
                });
            });
        });

        // ============================================
        // FORM SUBMIT FUNCTIONS
        // ============================================
        
        async function addQuickExpense(e) {
    e.preventDefault();
    
    const form = e.target;
    const monto = parseFloat(form.querySelectorAll('input')[0].value);
    const categoria = form.querySelector('select').value;
    const descripcion = form.querySelectorAll('input')[1].value;
    
    try {
        // Guardar en Supabase
        const { data, error } = await supabaseClient
            .from('variable_expenses')
            .insert([{
                user_id: currentUser.id,
                space_id: null,
                category: categoria,
                description: descripcion || 'Sin descripci√≥n',
                amount: monto,
                expense_date: new Date().toISOString().split('T')[0]
            }]);
        
        if (error) throw error;
        
        alert('‚úÖ Gasto agregado exitosamente');
        closeModal('quickAddModal');
        form.reset();
        
        // Recargar lista de gastos variables
        loadGastosVariables();
        updateDashboard();
        
    } catch (error) {
        alert('‚ùå Error al guardar: ' + error.message);
        console.error('Error:', error);
    }
}

        function sendInvite(e) {
            e.preventDefault();
            // TODO: Create shared space and send invite
            alert('‚úÖ Invitaci√≥n enviada exitosamente');
            closeModal('inviteModal');
            e.target.reset();
        }
        
        async function addIngreso(e) {
    e.preventDefault();
    
    const form = e.target;
    const tipoIngreso = form.querySelector('select').value;
    const descripcion = form.querySelectorAll('input')[0].value;
    const monto = parseFloat(form.querySelectorAll('input')[1].value);
    const frecuencia = form.querySelectorAll('select')[1].value;
    const fechaPago = form.querySelectorAll('input')[2].value;
    
    try {
        // Guardar en Supabase
        const { data, error } = await supabaseClient
            .from('incomes')
            .insert([{
                user_id: currentUser.id,
                space_id: null, // Por ahora null, despu√©s implementaremos espacios
                source: tipoIngreso,
                type: 'exento', // Por ahora, despu√©s a√±adiremos parafiscales
                frequency: frecuencia.toLowerCase(),
                gross_amount: monto,
                net_amount: monto, // Por ahora igual, despu√©s calculamos parafiscales
            }]);
        
        if (error) throw error;
        
        alert('‚úÖ Ingreso agregado exitosamente');
        closeModal('addIngresoModal');
        form.reset();
        
        // Recargar lista de ingresos
        loadIngresos();
        updateDashboard();
        
    } catch (error) {
        alert('‚ùå Error al guardar: ' + error.message);
        console.error('Error:', error);
    }
}

        async function addGastoFijo(e) {
    e.preventDefault();
    
    const form = e.target;
    const categoria = form.querySelectorAll('select')[0].value;
    const descripcion = form.querySelectorAll('input')[0].value;
    const monto = parseFloat(form.querySelectorAll('input')[1].value);
    const diaPago = parseInt(form.querySelectorAll('input')[2].value);
    const recordatorio = form.querySelectorAll('select')[1].value;
    
    try {
        // Guardar en Supabase
        const { data, error } = await supabaseClient
            .from('fixed_expenses')
            .insert([{
                user_id: currentUser.id,
                space_id: null,
                category: categoria,
                description: descripcion,
                amount: monto,
                payment_day: diaPago,
                reminder_days: recordatorio ? parseInt(recordatorio) : null,
                is_paid: false
            }]);
        
        if (error) throw error;
        
        alert('‚úÖ Gasto fijo agregado exitosamente');
        closeModal('addGastoFijoModal');
        form.reset();
        
        // Recargar lista de gastos fijos
        loadGastosFijos();
        updateDashboard();
        
    } catch (error) {
        alert('‚ùå Error al guardar: ' + error.message);
        console.error('Error:', error);
    }
}

        async function addCategoria(e) {
    e.preventDefault();
    
    const form = e.target;
    const emoji = form.querySelectorAll('input')[0].value;
    const nombre = form.querySelectorAll('input')[1].value;
    
    try {
        // Guardar en Supabase
        const { data, error } = await supabaseClient
            .from('custom_categories')
            .insert([{
                user_id: currentUser.id,
                space_id: null,
                emoji: emoji,
                name: nombre
            }]);
        
        if (error) throw error;
        
        alert('‚úÖ Categor√≠a creada exitosamente');
        closeModal('addCategoriaModal');
        form.reset();
        
        // Recargar lista de categor√≠as
        loadCategorias();
        
    } catch (error) {
        alert('‚ùå Error al guardar: ' + error.message);
        console.error('Error:', error);
    }
}

        // ============================================
// LOAD INGRESOS FUNCTION
// ============================================

async function loadIngresos() {
    try {
        const { data, error } = await supabaseClient
            .from('incomes')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const ingresosPage = document.getElementById('ingresos');
        const emptyState = ingresosPage.querySelector('.empty-state');
        
        if (data && data.length > 0) {
            // Ocultar empty state
            if (emptyState) emptyState.style.display = 'none';
            
            // Crear o actualizar tabla
            let table = ingresosPage.querySelector('.ingresos-table');
            if (!table) {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = '<table class="ingresos-table" style="width:100%; border-collapse: collapse;"></table>';
                emptyState.parentNode.insertBefore(card, emptyState);
                table = card.querySelector('table');
            }
            
            // Construir tabla
            let html = `
                <thead>
                    <tr style="border-bottom: 2px solid var(--border);">
                        <th style="padding: 1rem; text-align: left;">Tipo</th>
                        <th style="padding: 1rem; text-align: left;">Frecuencia</th>
                        <th style="padding: 1rem; text-align: right;">Monto</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            let totalIngresos = 0;
            
            data.forEach(ingreso => {
                totalIngresos += parseFloat(ingreso.gross_amount || 0);
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 1rem;">${ingreso.source}</td>
                        <td style="padding: 1rem;">${ingreso.frequency}</td>
                        <td style="padding: 1rem; text-align: right; font-weight: 600;">
                            $${parseFloat(ingreso.gross_amount).toLocaleString('es-CO')}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                </tbody>
                <tfoot>
                    <tr style="border-top: 2px solid var(--border); font-weight: 700;">
                        <td colspan="2" style="padding: 1rem;">TOTAL MENSUAL</td>
                        <td style="padding: 1rem; text-align: right; color: var(--secondary);">
                            $${totalIngresos.toLocaleString('es-CO')}
                        </td>
                    </tr>
                </tfoot>
            `;
            
            table.innerHTML = html;
            
        } else {
            // Mostrar empty state
            if (emptyState) emptyState.style.display = 'block';
            const existingTable = ingresosPage.querySelector('.card table');
            if (existingTable) existingTable.parentElement.remove();
        }
        
    } catch (error) {
        console.error('Error al cargar ingresos:', error);
    }
}

// ============================================
// LOAD GASTOS FIJOS FUNCTION
// ============================================

async function loadGastosFijos() {
    try {
        const { data, error } = await supabaseClient
            .from('fixed_expenses')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('payment_day', { ascending: true });
        
        if (error) throw error;
        
        const gastosFijosPage = document.getElementById('gastos-fijos');
        const emptyState = gastosFijosPage.querySelector('.empty-state');
        
        if (data && data.length > 0) {
            // Ocultar empty state
            if (emptyState) emptyState.style.display = 'none';
            
            // Crear o actualizar tabla
            let table = gastosFijosPage.querySelector('.gastos-fijos-table');
            if (!table) {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = '<table class="gastos-fijos-table" style="width:100%; border-collapse: collapse;"></table>';
                emptyState.parentNode.insertBefore(card, emptyState);
                table = card.querySelector('table');
            }

            // Construir tabla
            let html = `
                <thead>
                    <tr style="border-bottom: 2px solid var(--border);">
                        <th style="padding: 1rem; text-align: left;">Descripci√≥n</th>
                        <th style="padding: 1rem; text-align: left;">Categor√≠a</th>
                        <th style="padding: 1rem; text-align: center;">D√≠a de Pago</th>
                        <th style="padding: 1rem; text-align: right;">Monto</th>
                        <th style="padding: 1rem; text-align: center;">Estado</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            let totalGastosFijos = 0;
            
            data.forEach(gasto => {
                totalGastosFijos += parseFloat(gasto.amount || 0);
                const estado = gasto.is_paid ? 
                    '<span class="badge badge-success">‚úì Pagado</span>' : 
                    '<span class="badge badge-primary">‚è≥ Pendiente</span>';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 1rem; font-weight: 600;">${gasto.description}</td>
                        <td style="padding: 1rem;">${gasto.category}</td>
                        <td style="padding: 1rem; text-align: center;">D√≠a ${gasto.payment_day}</td>
                        <td style="padding: 1rem; text-align: right; font-weight: 600;">
                            $${parseFloat(gasto.amount).toLocaleString('es-CO')}
                        </td>
                        <td style="padding: 1rem; text-align: center;">${estado}</td>
                    </tr>
                `;
            });
            
            html += `
                </tbody>
                <tfoot>
                    <tr style="border-top: 2px solid var(--border); font-weight: 700;">
                        <td colspan="3" style="padding: 1rem;">TOTAL MENSUAL</td>
                        <td style="padding: 1rem; text-align: right; color: var(--danger);">
                            $${totalGastosFijos.toLocaleString('es-CO')}
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            `;
            
            table.innerHTML = html;
            
        } else {
            // Mostrar empty state
            if (emptyState) emptyState.style.display = 'block';
            const existingTable = gastosFijosPage.querySelector('.card table');
            if (existingTable) existingTable.parentElement.remove();
        }
        
    } catch (error) {
        console.error('Error al cargar gastos fijos:', error);
    }
}
        // ============================================
// LOAD GASTOS VARIABLES FUNCTION
// ============================================

async function loadGastosVariables() {
    try {
        const { data, error } = await supabaseClient
            .from('variable_expenses')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('expense_date', { ascending: false });
        
        if (error) throw error;
        
        const gastosVariablesPage = document.getElementById('gastos-variables');
        const emptyState = gastosVariablesPage.querySelector('.empty-state');
        
        if (data && data.length > 0) {
            // Ocultar empty state
            if (emptyState) emptyState.style.display = 'none';
            
            // Crear o actualizar tabla
            let table = gastosVariablesPage.querySelector('.gastos-variables-table');
            if (!table) {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = '<table class="gastos-variables-table" style="width:100%; border-collapse: collapse;"></table>';
                emptyState.parentNode.insertBefore(card, emptyState);
                table = card.querySelector('table');
            }
            
            // Construir tabla
            let html = `
                <thead>
                    <tr style="border-bottom: 2px solid var(--border);">
                        <th style="padding: 1rem; text-align: left;">Fecha</th>
                        <th style="padding: 1rem; text-align: left;">Descripci√≥n</th>
                        <th style="padding: 1rem; text-align: left;">Categor√≠a</th>
                        <th style="padding: 1rem; text-align: right;">Monto</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            let totalGastosVariables = 0;
            
            data.forEach(gasto => {
                totalGastosVariables += parseFloat(gasto.amount || 0);
                const fecha = new Date(gasto.expense_date).toLocaleDateString('es-CO');
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 1rem;">${fecha}</td>
                        <td style="padding: 1rem; font-weight: 600;">${gasto.description}</td>
                        <td style="padding: 1rem;">${gasto.category}</td>
                        <td style="padding: 1rem; text-align: right; font-weight: 600;">
                            $${parseFloat(gasto.amount).toLocaleString('es-CO')}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                </tbody>
                <tfoot>
                    <tr style="border-top: 2px solid var(--border); font-weight: 700;">
                        <td colspan="3" style="padding: 1rem;">TOTAL DEL MES</td>
                        <td style="padding: 1rem; text-align: right; color: var(--danger);">
                            $${totalGastosVariables.toLocaleString('es-CO')}
                        </td>
                    </tr>
                </tfoot>
            `;
            
            table.innerHTML = html;
            
        } else {
            // Mostrar empty state
            if (emptyState) emptyState.style.display = 'block';
            const existingTable = gastosVariablesPage.querySelector('.card table');
            if (existingTable) existingTable.parentElement.remove();
        }
        
    } catch (error) {
        console.error('Error al cargar gastos variables:', error);
    }
}
        // ============================================
// LOAD CATEGORIAS FUNCTION
// ============================================

async function loadCategorias() {
    try {
        const { data, error } = await supabaseClient
            .from('custom_categories')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const categoriasPage = document.getElementById('categorias');
        const cards = categoriasPage.querySelectorAll('.card');
        const customCard = cards[1]; // Segunda card (categor√≠as personalizadas)
        
        if (data && data.length > 0) {
            // Crear contenedor de badges
            let html = '<div style="margin-top: 1rem;">';
            
            data.forEach(categoria => {
                html += `
                    <span class="badge badge-success" style="position: relative; padding-right: 2.5rem;">
                        ${categoria.emoji} ${categoria.name}
                        <button 
                            onclick="deleteCategoria('${categoria.id}')" 
                            style="position: absolute; right: 0.5rem; background: none; border: none; color: var(--danger); cursor: pointer; font-weight: bold;"
                        >√ó</button>
                    </span>
                `;
            });
            
            html += '</div>';
            
            // Reemplazar empty state con las categor√≠as
            const emptyState = customCard.querySelector('.empty-state');
            if (emptyState) {
                emptyState.outerHTML = html;
            } else {
                // Si ya existe el contenedor, solo actualizarlo
                const container = customCard.querySelector('div[style*="margin-top"]');
                if (container) {
                    container.outerHTML = html;
                }
            }
            
        } else {
            // Mostrar empty state
            const container = customCard.querySelector('div[style*="margin-top"]');
            if (container) {
                container.outerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ú®</div>
                        <p style="font-size: 0.9rem;">Crea categor√≠as personalizadas para tus necesidades</p>
                    </div>
                `;
            }
        }
        
    } catch (error) {
        console.error('Error al cargar categor√≠as:', error);
    }
}

// ============================================
// DELETE CATEGORIA FUNCTION
// ============================================

async function deleteCategoria(categoriaId) {
    if (!confirm('¬øEst√°s seguro de eliminar esta categor√≠a?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('custom_categories')
            .delete()
            .eq('id', categoriaId);
        
        if (error) throw error;
        
        alert('‚úÖ Categor√≠a eliminada');
        loadCategorias();
        
    } catch (error) {
        alert('‚ùå Error al eliminar: ' + error.message);
        console.error('Error:', error);
    }
}
        async function addIngreso(e) {
    e.preventDefault();
    
    const form = e.target;
    const tipoIngreso = form.querySelector('select').value;
    const descripcion = form.querySelectorAll('input')[0].value;
    const monto = parseFloat(form.querySelectorAll('input')[1].value);
    const frecuencia = form.querySelectorAll('select')[1].value;
    const fechaPago = form.querySelectorAll('input')[2].value;
    
    try {
        // Guardar en Supabase
        const { data, error } = await supabaseClient
            .from('incomes')
            .insert([{
                user_id: currentUser.id,
                space_id: null, // Por ahora null, despu√©s implementaremos espacios
                source: tipoIngreso,
                type: 'exento', // Por ahora, despu√©s a√±adiremos parafiscales
                frequency: frecuencia.toLowerCase(),
                gross_amount: monto,
                net_amount: monto, // Por ahora igual, despu√©s calculamos parafiscales
            }]);
        
        if (error) throw error;
        
        alert('‚úÖ Ingreso agregado exitosamente');
        closeModal('addIngresoModal');
        form.reset();
        
        // Recargar lista de ingresos
        loadIngresos();
        
    } catch (error) {
        alert('‚ùå Error al guardar: ' + error.message);
        console.error('Error:', error);
    }
}
        // ============================================
// UPDATE DASHBOARD FUNCTION
// ============================================

async function updateDashboard() {
    try {
        // Obtener todos los datos
        const [ingresosData, gastosFijosData, gastosVariablesData] = await Promise.all([
            supabaseClient.from('incomes').select('*').eq('user_id', currentUser.id),
            supabaseClient.from('fixed_expenses').select('*').eq('user_id', currentUser.id),
            supabaseClient.from('variable_expenses').select('*').eq('user_id', currentUser.id)
        ]);
        
        // Calcular totales
        const totalIngresos = (ingresosData.data || []).reduce((sum, item) => sum + parseFloat(item.gross_amount || 0), 0);
        const totalGastosFijos = (gastosFijosData.data || []).reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
        const totalGastosVariables = (gastosVariablesData.data || []).reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
        const balance = totalIngresos - totalGastosFijos - totalGastosVariables;
        
        // Actualizar balance principal
        const balanceAmount = document.querySelector('.balance-amount');
        if (balanceAmount) {
            balanceAmount.textContent = `$${balance.toLocaleString('es-CO')}`;
            // Cambiar color seg√∫n sea positivo o negativo
            const balanceCard = document.querySelector('.balance-card');
            if (balance < 0) {
                balanceCard.style.background = 'linear-gradient(135deg, var(--danger), #DC2626)';
            } else {
                balanceCard.style.background = 'linear-gradient(135deg, var(--secondary), #059669)';
            }
        }
        
        // Actualizar resumen mensual
        const statRows = document.querySelectorAll('.stat-row .stat-value');
        if (statRows.length >= 4) {
            statRows[0].textContent = `$${totalIngresos.toLocaleString('es-CO')}`;
            statRows[0].style.color = 'var(--secondary)';
            
            statRows[1].textContent = `$${totalGastosFijos.toLocaleString('es-CO')}`;
            statRows[1].style.color = totalGastosFijos > 0 ? 'var(--danger)' : 'var(--text)';
            
            statRows[2].textContent = `$${totalGastosVariables.toLocaleString('es-CO')}`;
            statRows[2].style.color = totalGastosVariables > 0 ? 'var(--danger)' : 'var(--text)';
            
            statRows[3].textContent = `$${balance.toLocaleString('es-CO')}`;
            statRows[3].style.color = balance >= 0 ? 'var(--secondary)' : 'var(--danger)';
        }
        
        // Actualizar √∫ltimos gastos
        updateUltimosGastos(gastosVariablesData.data || []);
        
    } catch (error) {
        console.error('Error al actualizar dashboard:', error);
    }
}

// ============================================
// UPDATE ULTIMOS GASTOS FUNCTION
// ============================================

function updateUltimosGastos(gastos) {
    const cards = document.querySelectorAll('.card');
let ultimosGastosCard = null;
cards.forEach(card => {
    const title = card.querySelector('.card-title');
    if (title && title.textContent.includes('√öltimos Gastos')) {
        ultimosGastosCard = card;
    }
});
if (!ultimosGastosCard) return;
    
    const emptyState = ultimosGastosCard.querySelector('.empty-state');
    
    if (gastos && gastos.length > 0) {
        // Ocultar empty state
        if (emptyState) emptyState.style.display = 'none';
        
        // Tomar los √∫ltimos 5 gastos
        const ultimosGastos = gastos.slice(0, 5);
        
        // Crear o actualizar lista
        let lista = ultimosGastosCard.querySelector('.gastos-list');
        if (!lista) {
            lista = document.createElement('div');
            lista.className = 'gastos-list';
            emptyState.parentNode.insertBefore(lista, emptyState);
        }
        
        let html = '';
        ultimosGastos.forEach(gasto => {
            const fecha = new Date(gasto.expense_date).toLocaleDateString('es-CO', { day: 'numeric', month: 'short' });
            html += `
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid var(--border);">
                    <div>
                        <div style="font-weight: 600;">${gasto.description}</div>
                        <div style="font-size: 0.85rem; color: var(--text-light);">${gasto.category} ‚Ä¢ ${fecha}</div>
                    </div>
                    <div style="font-weight: 600; color: var(--danger);">
                        $${parseFloat(gasto.amount).toLocaleString('es-CO')}
                    </div>
                </div>
            `;
        });
        
        lista.innerHTML = html;
        
    } else {
        // Mostrar empty state
        if (emptyState) emptyState.style.display = 'block';
        const existingList = ultimosGastosCard.querySelector('.gastos-list');
        if (existingList) existingList.remove();
    }
}

        // ============================================
        // THEME FUNCTIONS
        // ============================================
        
        function toggleDarkMode() {
            const dark = document.getElementById('darkModeToggle').checked;
            if(dark) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            }
        }
        
        // ============================================
// SAVE PREFERENCES FUNCTION
// ============================================

async function savePreferences() {
    const moneda = document.getElementById('monedaSelect').value;
    const ciclo = parseInt(document.getElementById('cicloInput').value);
    
    if (ciclo < 1 || ciclo > 31) {
        alert('‚ùå El d√≠a del ciclo debe estar entre 1 y 31');
        return;
    }
    
    try {
        // Guardar en localStorage (para uso inmediato)
        localStorage.setItem('moneda', moneda);
        localStorage.setItem('ciclo_inicio', ciclo);
        
        // Tambi√©n guardar en Supabase para sincronizar entre dispositivos
        const { error } = await supabaseClient
            .from('users')
            .update({
                preferences: {
                    moneda: moneda,
                    ciclo_inicio: ciclo
                }
            })
            .eq('id', currentUser.id);
        
        if (error) console.log('No se pudo guardar en DB:', error);
        
        alert('‚úÖ Preferencias guardadas exitosamente');
        
        // Actualizar ciclo en el dashboard
        updateCicloDisplay();
        
    } catch (error) {
        console.error('Error al guardar preferencias:', error);
        alert('‚ö†Ô∏è Preferencias guardadas localmente');
    }
}

// ============================================
// LOAD PREFERENCES FUNCTION
// ============================================

function loadPreferences() {
    // Cargar moneda
    const moneda = localStorage.getItem('moneda') || 'COP';
    const monedaSelect = document.getElementById('monedaSelect');
    if (monedaSelect) monedaSelect.value = moneda;
    
    // Cargar ciclo
    const ciclo = localStorage.getItem('ciclo_inicio') || '20';
    const cicloInput = document.getElementById('cicloInput');
    if (cicloInput) cicloInput.value = ciclo;
    
    // Actualizar display del ciclo
    updateCicloDisplay();
}

// ============================================
// UPDATE CICLO DISPLAY FUNCTION
// ============================================

function updateCicloDisplay() {
    const cicloInicio = parseInt(localStorage.getItem('ciclo_inicio') || '20');
    const hoy = new Date();
    const mesActual = hoy.getMonth();
    const a√±oActual = hoy.getFullYear();
    
    let fechaInicio, fechaFin;
    
    if (hoy.getDate() >= cicloInicio) {
        // Estamos en el ciclo actual
        fechaInicio = new Date(a√±oActual, mesActual, cicloInicio);
        fechaFin = new Date(a√±oActual, mesActual + 1, cicloInicio - 1);
    } else {
        // Estamos en el ciclo del mes anterior
        fechaInicio = new Date(a√±oActual, mesActual - 1, cicloInicio);
        fechaFin = new Date(a√±oActual, mesActual, cicloInicio - 1);
    }
    
    const opciones = { day: 'numeric', month: 'short', year: 'numeric' };
    const textoInicio = fechaInicio.toLocaleDateString('es-CO', opciones);
    const textoFin = fechaFin.toLocaleDateString('es-CO', opciones);
    
    const cicloDisplay = document.querySelector('.welcome p');
    if (cicloDisplay) {
        cicloDisplay.textContent = `Ciclo actual: ${textoInicio} - ${textoFin}`;
    }
}
        // ============================================
// UPDATE USER NAME FUNCTION
// ============================================

async function updateUserName() {
    const newName = document.getElementById('userNameInput').value.trim();
    
    if (!newName) {
        alert('‚ùå Por favor ingresa un nombre');
        return;
    }
    
    try {
        // Update user metadata in Supabase Auth
        const { data, error } = await supabaseClient.auth.updateUser({
            data: { name: newName }
        });
        
        if (error) throw error;
        
        // Update local user object
        currentUser = data.user;
        
        // Update UI
        document.getElementById('userName').textContent = newName;
        
        // Also try to update users table if it exists
        try {
            await supabaseClient
                .from('users')
                .update({ name: newName })
                .eq('id', currentUser.id);
        } catch (dbError) {
            console.log('Users table update skipped');
        }
        
        alert('‚úÖ Nombre actualizado exitosamente');
        
    } catch (error) {
        alert('‚ùå Error al actualizar: ' + error.message);
    }
}
    </script>
</body>
</html>
