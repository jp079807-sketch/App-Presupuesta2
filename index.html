<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuesta2 - Finanzas Inteligentes</title>
    <style>
        /* ========================================
           VARIABLES Y RESET
           ======================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --bg: #F9FAFB;
            --card: #FFFFFF;
            --text: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        [data-theme="dark"] {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --bg: #111827;
            --card: #1F2937;
            --text: #F9FAFB;
            --text-light: #9CA3AF;
            --border: #374151;
            --shadow: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s, color 0.3s;
            line-height: 1.6;
        }

        /* ========================================
           AUTH SCREEN
           ======================================== */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), #818CF8);
        }

        .auth-card {
            background: var(--card);
            padding: 2.5rem;
            border-radius: 20px;
            max-width: 420px;
            width: 100%;
            box-shadow: var(--shadow-lg);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-logo h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .auth-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg);
            padding: 0.25rem;
            border-radius: 12px;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text);
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: var(--card);
            color: var(--primary);
            box-shadow: var(--shadow);
        }

        .auth-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
            display: none;
        }

        .auth-message.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            display: block;
        }

        .auth-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
            display: block;
        }

        /* ========================================
           MAIN APP LAYOUT
           ======================================== */
        .app {
            display: none;
        }

        .app.active {
            display: block;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), #818CF8);
            color: white;
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .user-menu {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .nav-menu {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--card);
            overflow-x: auto;
            box-shadow: var(--shadow);
            border-bottom: 1px solid var(--border);
        }

        .nav-menu::-webkit-scrollbar {
            height: 6px;
        }

        .nav-menu::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .nav-item {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .nav-item:hover {
            background: var(--bg);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .dashboard {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========================================
           CARDS & COMPONENTS
           ======================================== */
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .balance-card {
            background: linear-gradient(135deg, var(--secondary), #059669);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin: 2rem 0;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
        }

        .balance-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-light);
        }

        .stat-value {
            font-weight: 600;
        }

        .info-box {
            background: rgba(79, 70, 229, 0.05);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4rem;
            opacity: 0.5;
            margin-bottom: 1rem;
        }

        /* ========================================
           BUTTONS
           ======================================== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #818CF8);
            color: white;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.4);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
        }

        /* ========================================
           MODALS
           ======================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            padding: 2rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--bg);
        }

        /* ========================================
           FORMS
           ======================================== */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            color: var(--text);
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .calculation-box {
            background: rgba(16, 185, 129, 0.05);
            border: 2px solid var(--secondary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .calculation-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
        }

        /* ========================================
           SIDEBAR
           ======================================== */
        .sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: var(--card);
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            transition: right 0.3s;
            z-index: 200;
            overflow-y: auto;
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 150;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary), #818CF8);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .sidebar-content {
            padding: 1rem;
        }

        .sidebar-section {
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background: var(--bg);
            overflow: hidden;
        }

        .sidebar-section-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .sidebar-section-header:hover {
            background: var(--border);
        }

        .sidebar-section-title {
            font-weight: 600;
        }

        .sidebar-section-arrow {
            transition: transform 0.3s;
        }

        .sidebar-section-arrow.open {
            transform: rotate(180deg);
        }

        .sidebar-section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
            padding: 0 1rem;
        }

        .sidebar-section-content.open {
            max-height: 1000px;
            padding: 1rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border);
            border-radius: 26px;
            transition: 0.4s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background: white;
            border-radius: 50%;
            transition: 0.4s;
        }

        input:checked + .toggle-slider {
            background: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-primary {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* ========================================
           RESPONSIVE
           ======================================== */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                right: -100%;
            }

            .dashboard {
                padding: 1rem;
            }

            .balance-amount {
                font-size: 2rem;
            }

            .fab {
                bottom: 1rem;
                right: 1rem;
                width: 56px;
                height: 56px;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- ========================================
         AUTH SCREEN
         ======================================== -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <h1>üí∞ Presupuesta2</h1>
                <p>Tu aliado financiero</p>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Iniciar Sesi√≥n</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Registrarse</button>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" class="form-input" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Iniciar Sesi√≥n</button>
            </form>

            <form id="registerForm" style="display:none" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-input" id="registerName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" class="form-input" id="registerPassword" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Crear Cuenta</button>
            </form>

            <div id="authMessage" class="auth-message"></div>
        </div>
    </div>

    <!-- ========================================
         MAIN APP
         ======================================== -->
    <div id="mainApp" class="app">
        <header class="header">
            <div class="header-content">
                <div class="logo">üí∞ Presupuesta2</div>
                <div class="user-menu">
                    <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
                </div>
            </div>
        </header>

        <nav class="nav-menu">
            <div class="nav-item active" onclick="showPage('dashboard', this)">üìä Dashboard</div>
            <div class="nav-item" onclick="showPage('ingresos', this)">üíµ Ingresos</div>
            <div class="nav-item" onclick="showPage('gastos-fijos', this)">üìå Gastos Fijos</div>
            <div class="nav-item" onclick="showPage('gastos-variables', this)">üí∏ Gastos Variables</div>
            <div class="nav-item" onclick="showPage('deudas', this)">üí≥ Deudas</div>
            <div class="nav-item" onclick="showPage('mercado', this)">üõí Mercado</div>
            <div class="nav-item" onclick="showPage('categorias', this)">üè∑Ô∏è Categor√≠as</div>
        </nav>

        <main class="dashboard">
            <!-- DASHBOARD -->
            <div id="dashboard" class="page active">
                <h1 style="margin-bottom: 0.5rem;">Hola, <span id="userName">Usuario</span> üëã</h1>
                <p style="color: var(--text-light); margin-bottom: 2rem;" id="cycleText">Ciclo actual: Cargando...</p>

                <div class="balance-card">
                    <div class="balance-label">Balance del mes</div>
                    <div class="balance-amount" id="balanceAmount">$0</div>
                </div>

                <div class="card">
                    <h3 class="card-title">üìà Resumen Financiero</h3>
                    <div class="stat-row">
                        <span class="stat-label">üí∞ Ingresos</span>
                        <span class="stat-value" style="color: var(--secondary)" id="totalIngresos">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">üìå Gastos Fijos</span>
                        <span class="stat-value" id="totalGastosFijos">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">üí∏ Gastos Variables</span>
                        <span class="stat-value" id="totalGastosVariables">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">üí≥ Deudas</span>
                        <span class="stat-value" id="totalDeudas">$0</span>
                    </div>
                </div>

                <div class="grid">
                    <div class="card">
                        <h3 class="card-title">üí∏ √öltimos Gastos</h3>
                        <div id="ultimosGastos" class="empty-state">
                            <div class="empty-state-icon">üßæ</div>
                            <p>No hay gastos registrados</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">üìÖ Pr√≥ximos Pagos</h3>
                        <div id="proximosPagos" class="empty-state">
                            <div class="empty-state-icon">üìå</div>
                            <p>No hay pagos pr√≥ximos</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INGRESOS -->
            <div id="ingresos" class="page">
                <div class="card-header">
                    <h2>üíµ Ingresos</h2>
                    <button class="btn btn-primary" onclick="openModal('modalIngreso')">+ Agregar</button>
                </div>
                <div class="info-box">
                    üìå Registra tus fuentes de ingreso. El sistema calcula autom√°ticamente los descuentos parafiscales.
                </div>
                <div id="listaIngresos" class="empty-state">
                    <div class="empty-state-icon">üí∞</div>
                    <p>No hay ingresos registrados</p>
                </div>
            </div>

            <!-- GASTOS FIJOS -->
            <div id="gastos-fijos" class="page">
                <div class="card-header">
                    <h2>üìå Gastos Fijos</h2>
                    <button class="btn btn-primary" onclick="openModal('modalGastoFijo')">+ Agregar</button>
                </div>
                <div class="info-box">
                    üìå Gastos recurrentes cada mes (arriendo, servicios, suscripciones, etc.)
                </div>
                <div id="listaGastosFijos" class="empty-state">
                    <div class="empty-state-icon">üìÖ</div>
                    <p>No hay gastos fijos registrados</p>
                </div>
            </div>

            <!-- GASTOS VARIABLES -->
            <div id="gastos-variables" class="page">
                <div class="card-header">
                    <h2>üí∏ Gastos Variables</h2>
                    <button class="btn btn-primary" onclick="openModal('modalGastoVariable')">+ Agregar</button>
                </div>
                <div class="info-box">
                    üìå Gastos del d√≠a a d√≠a (comida, transporte, entretenimiento, etc.)
                </div>
                <div id="listaGastosVariables" class="empty-state">
                    <div class="empty-state-icon">üõí</div>
                    <p>No hay gastos variables este mes</p>
                </div>
            </div>

            <!-- DEUDAS -->
            <div id="deudas" class="page">
                <div class="card-header">
                    <h2>üí≥ Deudas</h2>
                    <button class="btn btn-primary" onclick="openModal('modalDeuda')">+ Agregar</button>
                </div>
                <div class="info-box">
                    üìå Controla tus deudas y pr√©stamos. Registra cada pago para ver tu progreso.
                </div>
                <div id="listaDeudas" class="empty-state">
                    <div class="empty-state-icon">üí≥</div>
                    <p>No tienes deudas registradas</p>
                </div>
            </div>

            <!-- MERCADO -->
            <div id="mercado" class="page">
                <div class="card-header">
                    <h2>üõí Lista de Mercado</h2>
                    <button class="btn btn-primary" onclick="openModal('modalMercado')">+ Agregar Item</button>
                </div>
                <div class="grid" style="margin-bottom: 2rem;">
                    <div class="card">
                        <h4 style="color: var(--text-light); margin-bottom: 0.5rem;">Presupuesto</h4>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="presupuestoMercado">$0</div>
                    </div>
                    <div class="card">
                        <h4 style="color: var(--text-light); margin-bottom: 0.5rem;">Gastado</h4>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--danger);" id="gastadoMercado">$0</div>
                    </div>
                    <div class="card">
                        <h4 style="color: var(--text-light); margin-bottom: 0.5rem;">Restante</h4>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--secondary);" id="restanteMercado">$0</div>
                    </div>
                </div>
                <div id="listaMercado" class="empty-state">
                    <div class="empty-state-icon">üõí</div>
                    <p>Tu lista est√° vac√≠a</p>
                </div>
            </div>

            <!-- CATEGOR√çAS -->
            <div id="categorias" class="page">
                <div class="card-header">
                    <h2>üè∑Ô∏è Categor√≠as</h2>
                    <button class="btn btn-primary" onclick="openModal('modalCategoria')">+ Crear</button>
                </div>
                <div class="card">
                    <h3 class="card-title">Predefinidas</h3>
                    <div style="margin-top: 1rem;">
                        <span class="badge badge-primary">üè† Vivienda</span>
                        <span class="badge badge-primary">üí° Servicios</span>
                        <span class="badge badge-primary">üçî Comida</span>
                        <span class="badge badge-primary">üöó Transporte</span>
                        <span class="badge badge-primary">üéÆ Entretenimiento</span>
                        <span class="badge badge-primary">üëï Ropa</span>
                        <span class="badge badge-primary">üíä Salud</span>
                        <span class="badge badge-primary">üéì Educaci√≥n</span>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Personalizadas</h3>
                    <div id="categoriasCustom" class="empty-state">
                        <div class="empty-state-icon">‚ú®</div>
                        <p>No hay categor√≠as personalizadas</p>
                    </div>
                </div>
            </div>
        </main>

        <button class="fab" onclick="openModal('modalGastoVariable')">+</button>
    </div>

    <!-- ========================================
         SIDEBAR (SETTINGS)
         ======================================== -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSettings()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">‚öôÔ∏è Configuraci√≥n</h2>
            <button class="close-btn" onclick="closeSettings()" style="color: white;">√ó</button>
        </div>
        <div class="sidebar-content">
            <!-- Usuario -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('user')">
                    <span class="sidebar-section-title">üë§ Usuario</span>
                    <span class="sidebar-section-arrow" id="user-arrow">‚ñº</span>
                </div>
                <div class="sidebar-section-content" id="user-content">
                    <p style="margin-bottom: 1rem;"><strong>Email:</strong> <span id="userEmail">-</span></p>
                    <button class="btn btn-danger" style="width: 100%;" onclick="handleLogout()">üö™ Cerrar Sesi√≥n</button>
                </div>
            </div>

            <!-- Preferencias -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('prefs')">
                    <span class="sidebar-section-title">üé® Preferencias</span>
                    <span class="sidebar-section-arrow" id="prefs-arrow">‚ñº</span>
                </div>
                <div class="sidebar-section-content" id="prefs-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span>üåô Modo Oscuro</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìÖ D√≠a de Inicio del Ciclo</label>
                        <input type="number" class="form-input" id="cycleDay" value="1" min="1" max="31">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="savePreferences()">üíæ Guardar</button>
                </div>
            </div>

            <!-- Compartido -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('shared')">
                    <span class="sidebar-section-title">üíë Presupuesto Compartido</span>
                    <span class="sidebar-section-arrow" id="shared-arrow">‚ñº</span>
                </div>
                <div class="sidebar-section-content" id="shared-content">
                    <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem;">
                        Comparte tu presupuesto con tu pareja o familia
                    </p>
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;" onclick="alert('üöß Pr√≥ximamente')">
                        ‚ûï Crear Presupuesto Compartido
                    </button>
                    <button class="btn" style="width: 100%; background: var(--bg);" onclick="alert('üöß Pr√≥ximamente')">
                        üîó Unirme a uno
                    </button>
                </div>
            </div>

            <!-- Datos -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" onclick="toggleSection('data')">
                    <span class="sidebar-section-title">üóëÔ∏è Datos</span>
                    <span class="sidebar-section-arrow" id="data-arrow">‚ñº</span>
                </div>
                <div class="sidebar-section-content" id="data-content">
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;" onclick="cleanOrphanData()">
                        üßπ Limpiar Datos Hu√©rfanos
                    </button>
                    <button class="btn btn-danger" style="width: 100%;" onclick="deleteAllData()">
                        ‚ö†Ô∏è Eliminar Todos Mis Datos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODALS
         ======================================== -->

    <!-- Modal Ingreso -->
    <div class="modal" id="modalIngreso">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üíµ Agregar Ingreso</h2>
                <button class="close-btn" onclick="closeModal('modalIngreso')">√ó</button>
            </div>
            <form onsubmit="addIngreso(event)">
                <div class="form-group">
                    <label class="form-label">Fuente</label>
                    <input type="text" class="form-input" id="ingresoFuente" placeholder="Ej: Salario Google" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Contrato</label>
                    <select class="form-select" id="ingresoTipo" onchange="calcularIngresoNeto()">
                        <option value="laboral">üíº Laboral (8% descuento)</option>
                        <option value="servicios">üí∞ Servicios (28.5% descuento)</option>
                        <option value="exento">üéÅ Exento (sin descuento)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto Bruto</label>
                    <input type="number" class="form-input" id="ingresoBruto" oninput="calcularIngresoNeto()" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Frecuencia</label>
                    <select class="form-select" id="ingresoFrecuencia">
                        <option value="unico">√önico</option>
                        <option value="mensual">Mensual</option>
                        <option value="quincenal">Quincenal</option>
                    </select>
                </div>
                <div class="calculation-box" id="ingresoCalculo">
                    <div class="calculation-row">
                        <span>Bruto:</span>
                        <strong id="calcBruto">$0</strong>
                    </div>
                    <div class="calculation-row">
                        <span>Descuento:</span>
                        <strong id="calcDescuento" style="color: var(--danger)">-$0</strong>
                    </div>
                    <div class="calculation-row" style="border-top: 2px solid var(--border); padding-top: 0.5rem; margin-top: 0.5rem;">
                        <span><strong>Neto:</strong></span>
                        <strong id="calcNeto" style="color: var(--secondary)">$0</strong>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Agregar</button>
            </form>
        </div>
    </div>

    <!-- Modal Gasto Fijo -->
    <div class="modal" id="modalGastoFijo">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìå Agregar Gasto Fijo</h2>
                <button class="close-btn" onclick="closeModal('modalGastoFijo')">√ó</button>
            </div>
            <form onsubmit="addGastoFijo(event)">
                <div class="form-group">
                    <label class="form-label">Categor√≠a</label>
                    <select class="form-select" required>
                        <option>üè† Vivienda</option>
                        <option>üí° Servicios</option>
                        <option>üöó Transporte</option>
                        <option>üì¶ Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-input" placeholder="Ej: Arriendo, Netflix" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto</label>
                    <input type="number" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">D√≠a de Pago (1-31)</label>
                    <input type="number" class="form-input" min="1" max="31" value="1" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Agregar</button>
            </form>
        </div>
    </div>

    <!-- Modal Gasto Variable -->
    <div class="modal" id="modalGastoVariable">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∏ Agregar Gasto</h2>
                <button class="close-btn" onclick="closeModal('modalGastoVariable')">√ó</button>
            </div>
            <form onsubmit="addGastoVariable(event)">
                <div class="form-group">
                    <label class="form-label">Categor√≠a</label>
                    <select class="form-select" required>
                        <option>üçî Comida</option>
                        <option>üöó Transporte</option>
                        <option>üéÆ Entretenimiento</option>
                        <option>üëï Ropa</option>
                        <option>üíä Salud</option>
                        <option>üì¶ Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-input" placeholder="Ej: Almuerzo, Uber" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto</label>
                    <input type="number" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Agregar</button>
            </form>
        </div>
    </div>

    <!-- Modal Deuda -->
    <div class="modal" id="modalDeuda">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí≥ Agregar Deuda</h2>
                <button class="close-btn" onclick="closeModal('modalDeuda')">√ó</button>
            </div>
            <form onsubmit="addDeuda(event)">
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" required>
                        <option>üí≥ Tarjeta de Cr√©dito</option>
                        <option>üè¶ Pr√©stamo Bancario</option>
                        <option>üë§ Pr√©stamo Personal</option>
                        <option>üì¶ Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-input" placeholder="Ej: Tarjeta Visa" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto Total</label>
                    <input type="number" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Cuota Mensual</label>
                    <input type="number" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Agregar</button>
            </form>
        </div>
    </div>

    <!-- Modal Mercado -->
    <div class="modal" id="modalMercado">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üõí Agregar Item</h2>
                <button class="close-btn" onclick="closeModal('modalMercado')">√ó</button>
            </div>
            <form onsubmit="addMercadoItem(event)">
                <div class="form-group">
                    <label class="form-label">Producto</label>
                    <input type="text" class="form-input" placeholder="Ej: Arroz" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Cantidad</label>
                    <input type="text" class="form-input" placeholder="Ej: 1kg, 2 unidades" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Precio Estimado</label>
                    <input type="number" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Agregar</button>
            </form>
        </div>
    </div>

    <!-- Modal Categor√≠a -->
    <div class="modal" id="modalCategoria">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üè∑Ô∏è Crear Categor√≠a</h2>
                <button class="close-btn" onclick="closeModal('modalCategoria')">√ó</button>
            </div>
            <form onsubmit="addCategoria(event)">
                <div class="form-group">
                    <label class="form-label">Emoji</label>
                    <input type="text" class="form-input" placeholder="üéØ" maxlength="2" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-input" placeholder="Ej: Mascotas" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Crear</button>
            </form>
        </div>
    </div>

    <!-- ========================================
         JAVASCRIPT
         ======================================== -->
    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const SUPABASE_URL = 'https://ctppigfvvqyizvzqfvzz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0cHBpZ2Z2dnF5aXp2enFmdnp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDkzNDcsImV4cCI6MjA4NDg4NTM0N30.er70gArSteC92YMwk6GS7rD8EKlAKrrRn25vqtJRLas';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        window.addEventListener('load', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                showApp();
            }
            loadTheme();
        });

        // ============================================
        // AUTENTICACI√ìN
        // ============================================
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('registerForm').style.display = 'block';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                currentUser = data.user;
                showApp();
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email, password,
                    options: { data: { name } }
                });
                
                if (error) throw error;
                
                showMessage('‚úÖ Cuenta creada exitosamente', 'success');
                setTimeout(() => showAuthTab('login'), 2000);
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        function showMessage(msg, type) {
            const el = document.getElementById('authMessage');
            el.textContent = msg;
            el.className = `auth-message ${type}`;
        }

        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            
            const userName = currentUser.user_metadata?.name || currentUser.email.split('@')[0];
            document.getElementById('userName').textContent = userName;
            document.getElementById('userEmail').textContent = currentUser.email;
            
            loadAll();
        }

        async function loadAll() {
            await Promise.all([
                loadIngresos(),
                loadGastosFijos(),
                loadGastosVariables(),
                loadCategorias()
            ]);
            updateDashboard();
            updateCycleText();
        }

        // ============================================
        // NAVEGACI√ìN
        // ============================================
        function showPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (el) el.classList.add('active');
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function openSettings() {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('sidebarOverlay').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        function toggleSection(id) {
            const content = document.getElementById(id + '-content');
            const arrow = document.getElementById(id + '-arrow');
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        // ============================================
        // INGRESOS
        // ============================================
        function calcularIngresoNeto() {
            const tipo = document.getElementById('ingresoTipo').value;
            const bruto = parseFloat(document.getElementById('ingresoBruto').value) || 0;
            
            if (bruto === 0) {
                document.getElementById('ingresoCalculo').style.display = 'none';
                return;
            }
            
            let descuento = 0;
            if (tipo === 'laboral') descuento = bruto * 0.08;
            else if (tipo === 'servicios') descuento = bruto * 0.285;
            
            const neto = bruto - descuento;
            
            document.getElementById('calcBruto').textContent = '$' + bruto.toLocaleString('es-CO');
            document.getElementById('calcDescuento').textContent = '-$' + descuento.toLocaleString('es-CO');
            document.getElementById('calcNeto').textContent = '$' + neto.toLocaleString('es-CO');
            document.getElementById('ingresoCalculo').style.display = 'block';
        }

        async function addIngreso(e) {
            e.preventDefault();
            const form = e.target;
            
            const fuente = document.getElementById('ingresoFuente').value;
            const tipo = document.getElementById('ingresoTipo').value;
            const bruto = parseFloat(document.getElementById('ingresoBruto').value);
            const frecuencia = document.getElementById('ingresoFrecuencia').value;
            
            let descuento = 0;
            if (tipo === 'laboral') descuento = bruto * 0.08;
            else if (tipo === 'servicios') descuento = bruto * 0.285;
            const neto = bruto - descuento;
            
            try {
                const { error } = await supabaseClient.from('incomes').insert([{
                    user_id: currentUser.id,
                    source: fuente,
                    type: tipo,
                    frequency: frecuencia,
                    gross_amount: bruto,
                    net_amount: neto
                }]);
                
                if (error) throw error;
                
                alert('‚úÖ Ingreso agregado');
                closeModal('modalIngreso');
                form.reset();
                document.getElementById('ingresoCalculo').style.display = 'none';
                loadIngresos();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function loadIngresos() {
            try {
                const { data, error } = await supabase
                    .from('incomes')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('listaIngresos');
                
                if (data && data.length > 0) {
                    let html = '<div class="card"><table style="width:100%; border-collapse: collapse;">';
                    html += '<thead><tr style="border-bottom: 2px solid var(--border);"><th style="padding: 1rem; text-align: left;">Fuente</th><th style="padding: 1rem; text-align: left;">Tipo</th><th style="padding: 1rem; text-align: right;">Neto</th></tr></thead><tbody>';
                    
                    data.forEach(i => {
                        const tipoIcon = i.type === 'laboral' ? 'üíº' : i.type === 'servicios' ? 'üí∞' : 'üéÅ';
                        html += `<tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 1rem;">${i.source}</td>
                            <td style="padding: 1rem;">${tipoIcon} ${i.type}</td>
                            <td style="padding: 1rem; text-align: right; font-weight: 600; color: var(--secondary);">$${parseFloat(i.net_amount).toLocaleString('es-CO')}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><p>No hay ingresos registrados</p></div>';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ============================================
        // GASTOS FIJOS
        // ============================================
        async function addGastoFijo(e) {
            e.preventDefault();
            const form = e.target;
            
            const categoria = form.querySelectorAll('select')[0].value;
            const descripcion = form.querySelectorAll('input')[0].value;
            const monto = parseFloat(form.querySelectorAll('input')[1].value);
            const diaPago = parseInt(form.querySelectorAll('input')[2].value);
            
            try {
                const { error } = await supabaseClient.from('fixed_expenses').insert([{
                    user_id: currentUser.id,
                    category: categoria,
                    description: descripcion,
                    amount: monto,
                    payment_day: diaPago,
                    is_paid: false
                }]);
                
                if (error) throw error;
                
                alert('‚úÖ Gasto fijo agregado');
                closeModal('modalGastoFijo');
                form.reset();
                loadGastosFijos();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function loadGastosFijos() {
            try {
                const { data, error } = await supabase
                    .from('fixed_expenses')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('payment_day', { ascending: true });
                
                if (error) throw error;
                
                const container = document.getElementById('listaGastosFijos');
                
                if (data && data.length > 0) {
                    let html = '<div class="card"><table style="width:100%; border-collapse: collapse;">';
                    html += '<thead><tr style="border-bottom: 2px solid var(--border);"><th style="padding: 1rem; text-align: left;">Descripci√≥n</th><th style="padding: 1rem; text-align: center;">D√≠a</th><th style="padding: 1rem; text-align: right;">Monto</th></tr></thead><tbody>';
                    
                    data.forEach(g => {
                        html += `<tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 1rem; font-weight: 600;">${g.description}</td>
                            <td style="padding: 1rem; text-align: center;">${g.payment_day}</td>
                            <td style="padding: 1rem; text-align: right; font-weight: 600; color: var(--danger);">$${parseFloat(g.amount).toLocaleString('es-CO')}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>No hay gastos fijos</p></div>';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ============================================
        // GASTOS VARIABLES
        // ============================================
        async function addGastoVariable(e) {
            e.preventDefault();
            const form = e.target;
            
            const categoria = form.querySelectorAll('select')[0].value;
            const descripcion = form.querySelectorAll('input')[0].value;
            const monto = parseFloat(form.querySelectorAll('input')[1].value);
            
            try {
                const { error } = await supabaseClient.from('variable_expenses').insert([{
                    user_id: currentUser.id,
                    category: categoria,
                    description: descripcion,
                    amount: monto,
                    expense_date: new Date().toISOString().split('T')[0]
                }]);
                
                if (error) throw error;
                
                alert('‚úÖ Gasto agregado');
                closeModal('modalGastoVariable');
                form.reset();
                loadGastosVariables();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function loadGastosVariables() {
            try {
                const { data, error } = await supabase
                    .from('variable_expenses')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('expense_date', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('listaGastosVariables');
                
                if (data && data.length > 0) {
                    let html = '<div class="card"><table style="width:100%; border-collapse: collapse;">';
                    html += '<thead><tr style="border-bottom: 2px solid var(--border);"><th style="padding: 1rem; text-align: left;">Descripci√≥n</th><th style="padding: 1rem; text-align: center;">Fecha</th><th style="padding: 1rem; text-align: right;">Monto</th></tr></thead><tbody>';
                    
                    data.forEach(g => {
                        const fecha = new Date(g.expense_date).toLocaleDateString('es-CO', { day: 'numeric', month: 'short' });
                        html += `<tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 1rem; font-weight: 600;">${g.description}</td>
                            <td style="padding: 1rem; text-align: center;">${fecha}</td>
                            <td style="padding: 1rem; text-align: right; font-weight: 600; color: var(--danger);">$${parseFloat(g.amount).toLocaleString('es-CO')}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üõí</div><p>No hay gastos variables</p></div>';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ============================================
        // OTRAS FUNCIONES
        // ============================================
        async function addDeuda(e) {
            e.preventDefault();
            alert('üöß Funci√≥n en desarrollo');
            closeModal('modalDeuda');
        }

        async function addMercadoItem(e) {
            e.preventDefault();
            alert('üöß Funci√≥n en desarrollo');
            closeModal('modalMercado');
        }

        async function addCategoria(e) {
            e.preventDefault();
            alert('üöß Funci√≥n en desarrollo');
            closeModal('modalCategoria');
        }

        async function loadCategorias() {
            // Placeholder
        }

        // ============================================
        // DASHBOARD
        // ============================================
        async function updateDashboard() {
            try {
                const [ingresos, gastosFijos, gastosVariables] = await Promise.all([
                    supabaseClient.from('incomes').select('*').eq('user_id', currentUser.id),
                    supabaseClient.from('fixed_expenses').select('*').eq('user_id', currentUser.id),
                    supabaseClient.from('variable_expenses').select('*').eq('user_id', currentUser.id)
                ]);
                
                const totalIngresos = (ingresos.data || []).reduce((sum, i) => sum + parseFloat(i.net_amount || 0), 0);
                const totalGastosFijos = (gastosFijos.data || []).reduce((sum, g) => sum + parseFloat(g.amount || 0), 0);
                const totalGastosVariables = (gastosVariables.data || []).reduce((sum, g) => sum + parseFloat(g.amount || 0), 0);
                const balance = totalIngresos - totalGastosFijos - totalGastosVariables;
                
                document.getElementById('balanceAmount').textContent = '$' + balance.toLocaleString('es-CO');
                document.getElementById('totalIngresos').textContent = '$' + totalIngresos.toLocaleString('es-CO');
                document.getElementById('totalGastosFijos').textContent = '$' + totalGastosFijos.toLocaleString('es-CO');
                document.getElementById('totalGastosVariables').textContent = '$' + totalGastosVariables.toLocaleString('es-CO');
                
                const balanceCard = document.querySelector('.balance-card');
                if (balance < 0) {
                    balanceCard.style.background = 'linear-gradient(135deg, var(--danger), #DC2626)';
                } else {
                    balanceCard.style.background = 'linear-gradient(135deg, var(--secondary), #059669)';
                }
                
                updateUltimosGastos(gastosVariables.data || []);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateUltimosGastos(gastos) {
            const container = document.getElementById('ultimosGastos');
            
            if (gastos && gastos.length > 0) {
                let html = '';
                gastos.slice(0, 5).forEach(g => {
                    const fecha = new Date(g.expense_date).toLocaleDateString('es-CO', { day: 'numeric', month: 'short' });
                    html += `<div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                        <div>
                            <div style="font-weight: 600;">${g.description}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">${g.category} ‚Ä¢ ${fecha}</div>
                        </div>
                        <div style="font-weight: 600; color: var(--danger);">$${parseFloat(g.amount).toLocaleString('es-CO')}</div>
                    </div>`;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üßæ</div><p>No hay gastos</p></div>';
            }
        }

        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        function toggleDarkMode() {
            const isDark = document.getElementById('darkModeToggle').checked;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : '');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function loadTheme() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                const toggle = document.getElementById('darkModeToggle');
                if (toggle) toggle.checked = true;
            }
        }

        function savePreferences() {
            const cycleDay = document.getElementById('cycleDay').value;
            localStorage.setItem('cycleDay', cycleDay);
            alert('‚úÖ Preferencias guardadas');
            updateCycleText();
        }

        function updateCycleText() {
            const cycleDay = parseInt(localStorage.getItem('cycleDay') || '1');
            const today = new Date();
            const month = today.getMonth();
            const year = today.getFullYear();
            
            let startDate, endDate;
            if (today.getDate() >= cycleDay) {
                startDate = new Date(year, month, cycleDay);
                endDate = new Date(year, month + 1, cycleDay - 1);
            } else {
                startDate = new Date(year, month - 1, cycleDay);
                endDate = new Date(year, month, cycleDay - 1);
            }
            
            const opts = { day: 'numeric', month: 'short' };
            const start = startDate.toLocaleDateString('es-CO', opts);
            const end = endDate.toLocaleDateString('es-CO', opts);
            
            document.getElementById('cycleText').textContent = `Ciclo actual: ${start} - ${end}`;
        }

        async function cleanOrphanData() {
            if (!confirm('¬øLimpiar datos hu√©rfanos?')) return;
            
            try {
                await Promise.all([
                    supabaseClient.from('variable_expenses').delete().is('user_id', null),
                    supabaseClient.from('fixed_expenses').delete().is('user_id', null),
                    supabaseClient.from('incomes').delete().is('user_id', null)
                ]);
                
                alert('‚úÖ Datos limpiados');
                loadAll();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function deleteAllData() {
            const confirm = prompt('Escribe "ELIMINAR" para confirmar:');
            if (confirm !== 'ELIMINAR') return;
            
            try {
                await Promise.all([
                    supabaseClient.from('variable_expenses').delete().eq('user_id', currentUser.id),
                    supabaseClient.from('fixed_expenses').delete().eq('user_id', currentUser.id),
                    supabaseClient.from('incomes').delete().eq('user_id', currentUser.id)
                ]);
                
                alert('‚úÖ Todos los datos eliminados');
                loadAll();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Cerrar modales al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>
